<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C4 - Gestão Financeira</title>
    
    <!-- Importação da Fonte Poppins do Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Ícones (SVG embutido para evitar dependências externas) -->
    <style>
        .icon {
            width: 24px;
            height: 24px;
            display: inline-block;
            vertical-align: middle;
        }
    </style>

    <style>
        /* CSS PURO - SEM FRAMEWORKS */

        /* ------------------- */
        /* RESET BÁSICO E VARIÁVEIS */
        /* ------------------- */
        :root {
            /* Paleta Principal */
            --cor-principal: #db1472;
            --cor-secundaria: #f8b81f;
            
            /* Tons de Texto */
            --cor-texto: #831843;
            --cor-texto-secundario: #6b7280;
            --cor-texto-claro: #ffffff;

            /* Fundos */
            --cor-fundo-app: #fdf2f8; 
            --cor-fundo-card: #ffffff;

            /* Cores de Status */
            --cor-sucesso: #10b981;
            --cor-alerta: #f59e0b;
            --cor-erro: #ef4444;
            --cor-info: #3b82f6;

            /* UI Geral */
            --sombra-card: 0 4px 10px rgba(131, 24, 67, 0.08);
            --borda-radius: 12px;
            --borda-card: 1px solid #fbcfe8;
            --font-principal: 'Poppins', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 100%; } /* Base 16px */
        body { font-family: var(--font-principal); background-color: var(--cor-fundo-app); color: var(--cor-texto); overscroll-behavior-x: none; line-height: 1.5; }

        /* ------------------- */
        /* ESTRUTURA PRINCIPAL E NAVEGAÇÃO */
        /* ------------------- */
        .side-menu { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 280px; 
            height: 100%; 
            background-color: var(--cor-principal); 
            color: var(--cor-texto-claro); 
            transform: translateX(-100%); 
            transition: transform 0.3s ease-in-out; 
            z-index: 1000; 
            display: flex; 
            flex-direction: column; 
        }
        .side-menu.active { 
            transform: translateX(0); 
        }
        .menu-header { padding: 20px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.2); position: relative; }
        .menu-header h2 { font-size: 1.5rem; font-weight: 700; margin-top: 10px; line-height: 1.2; }
        .menu-header h2 span { color: var(--cor-secundaria); }
        .menu-links { list-style: none; flex-grow: 1; overflow-y: auto; }
        .menu-links a { display: flex; align-items: center; gap: 15px; padding: 16px 20px; color: var(--cor-texto-claro); text-decoration: none; font-size: 1rem; font-weight: 500; transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease; border-left: 4px solid transparent; }
        .menu-links a:active { transform: scale(0.98); }
        .menu-links a.active, .menu-links a:hover { background-color: var(--cor-secundaria); color: var(--cor-principal); border-left-color: var(--cor-texto-claro); }
        
        .overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.5); 
            z-index: 999; 
            opacity: 0; 
            visibility: hidden; 
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; 
        }
        .overlay.active { 
            opacity: 1; 
            visibility: visible; 
        }
        
        .main-container { 
            transition: margin-left 0.3s ease-in-out; 
            min-height: 100vh; 
        }

        .close-menu-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: transparent;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ------------------- */
        /* CABEÇALHO DA PÁGINA */
        /* ------------------- */
        .app-header { display: flex; align-items: center; justify-content: space-between; padding: 16px; background: linear-gradient(135deg, var(--cor-principal), #f472b6); color: var(--cor-texto-claro); position: sticky; top: 0; z-index: 900;}
        .hamburger-menu { background: none; border: none; cursor: pointer; padding: 10px; width: 44px; height: 44px; }
        .app-header-title { font-size: 1.2rem; font-weight: 600; line-height: 1.2; }
        .header-actions { width: 44px; }

        /* ------------------- */
        /* CONTEÚDO DAS PÁGINAS */
        /* ------------------- */
        .page { display: none; padding: 16px; animation: fadeIn 0.2s ease-in-out; }
        .page > *:not(:last-child) { margin-bottom: 24px; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .page-title { font-size: 1.5rem; /* 24px */ font-weight: 700; margin-bottom: 5px; color: var(--cor-texto); line-height: 1.2; }
        .page-subtitle { font-size: 1rem; /* 16px */ margin-bottom: 24px; color: var(--cor-texto-secundario); font-weight: 400; }

        /* ------------------- */
        /* ESTILOS DE CARDS */
        /* ------------------- */
        .card { background-color: var(--cor-fundo-card); border-radius: var(--borda-radius); padding: 20px; box-shadow: var(--sombra-card); border: var(--borda-card); transition: transform 0.2s ease, box-shadow 0.2s ease; min-height: 120px;}
        .card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(131, 24, 67, 0.12); }
        .card-title { font-size: 1.125rem; /* 18px */ font-weight: 600; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; color: var(--cor-texto); line-height: 1.2;}
        .card-content { font-size: 1.8rem; font-weight: 700; color: var(--cor-principal); }
        .card-content .currency { font-size: 1rem; font-weight: 500; color: var(--cor-texto); margin-right: 4px; }
        .card-content .detail { font-size: 0.875rem; /* 14px */ font-weight: 400; color: var(--cor-texto-secundario); display: block; margin-top: 5px; }


        /* ------------------- */
        /* ESTILOS DE FORMULÁRIO */
        /* ------------------- */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .form-group { margin-bottom: 16px; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 8px; font-size: 0.9rem; color: #52525b; }
        .form-group input, .form-group select { width: 100%; min-height: 48px; padding: 14px 12px; border: 1px solid #d4d4d8; border-radius: 8px; font-size: 1rem; color: var(--cor-texto); background-color: #fafafa; font-family: var(--font-principal); transition: border-color 0.2s, box-shadow 0.2s; }
        .form-group input:focus, .form-group select:focus { border-color: var(--cor-principal); outline: none; box-shadow: 0 0 0 2px rgba(219, 20, 114, 0.2); }
        .form-group input[readonly] { background-color: #f1f5f9; cursor: not-allowed; }
        .btn { padding: 14px 20px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s, transform 0.2s, filter 0.2s; width: 100%; font-family: var(--font-principal); display: flex; align-items: center; justify-content: center; gap: 8px; min-height: 48px; }
        .btn:hover { filter: brightness(1.1); }
        .btn:active { transform: scale(0.98); filter: brightness(0.95); }
        .btn-primary { background-color: var(--cor-principal); color: var(--cor-texto-claro); }
        .btn-secondary { background-color: #f1f5f9; color: var(--cor-texto); border: 1px solid #e2e8f0; }
        .btn-sm { padding: 10px; width: 44px; height: 44px; }
        .btn-danger { background-color: #fee2e2; color: var(--cor-erro); }
        .btn-danger:hover { background-color: #fecaca; }
        
        /* ------------------- */
        /* GRID LAYOUTS */
        /* ------------------- */
        .main-grid { display: grid; gap: 16px; grid-template-columns: 1fr; }
        .dashboard-grid { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); margin-bottom: 24px;}
        
        /* ------------------- */
        /* COMPONENTES DO DASHBOARD */
        /* ------------------- */
        .quick-access-buttons { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 15px; margin-bottom: 24px; -ms-overflow-style: none; scrollbar-width: none; }
        .quick-access-buttons::-webkit-scrollbar { display: none; }
        .quick-btn { display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 15px; background-color: var(--cor-fundo-card); border-radius: var(--borda-radius); box-shadow: var(--sombra-card); border: var(--borda-card); text-decoration: none; color: var(--cor-texto); font-size: 0.8rem; font-weight: 500; min-width: 90px; text-align: center; cursor: pointer; transition: transform 0.2s, background-color 0.2s, color 0.2s, filter 0.2s; }
        .quick-btn:active { transform: scale(0.95); filter: brightness(0.95); }
        .quick-btn:hover { transform: scale(1.05); background-color: var(--cor-secundaria); color: var(--cor-principal); border-color: var(--cor-secundaria); }
        .quick-btn .icon { background-color: var(--cor-principal); color: var(--cor-texto-claro); padding: 10px; border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; }
        .pie-chart { width: 150px; height: 150px; border-radius: 50%; background: conic-gradient( var(--cor-sucesso) 0% 45%, var(--cor-alerta) 45% 75%, var(--cor-erro) 75% 90%, #a8a29e 90% 100%); position: relative; }
        .chart-legend { list-style: none; width: 100%; }
        .legend-item { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.9rem; color: var(--cor-texto-secundario); }
        .legend-color { width: 12px; height: 12px; border-radius: 3px; margin-right: 10px; }
        .progress-bar-container { margin-top: 10px; }
        .progress-bar { width: 100%; height: 10px; background-color: #fce7f3; border-radius: 5px; overflow: hidden; }
        .progress { height: 100%; background-color: var(--cor-principal); border-radius: 5px; transition: width 0.5s ease; }
        .progress-label { margin-top: 8px; font-size: 0.9rem; text-align: right; color: var(--cor-texto-secundario); }
        
        /* ------------------- */
        /* COMPONENTES DA PÁGINA DE DESPESAS */
        /* ------------------- */
        .info-tooltip { position: relative; display: inline-block; }
        .info-tooltip .icon { color: var(--cor-principal); cursor: help; }
        .info-tooltip .tooltip-text { visibility: hidden; width: 220px; background-color: #555; color: #fff; text-align: center; border-radius: 6px; padding: 10px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s; font-size: 0.85rem; font-weight: normal; }
        .info-tooltip:hover .tooltip-text { visibility: visible; opacity: 1; }
        .costs-list { list-style: none; margin-top: 20px; max-height: 250px; overflow-y: auto; padding-right: 5px;}
        .cost-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-radius: 6px; margin-bottom: 8px; background-color: #fdf2f8; }
        .cost-item div { display: flex; flex-direction: column; }
        .cost-item .cost-name { font-weight: 500; }
        .cost-item .cost-details { font-size: 0.8rem; color: var(--cor-texto-secundario); font-weight: 400; }
        .cost-item .cost-value { font-weight: 500; }
        .total-card { margin-top: 15px; padding: 15px; background-color: #fce7f3; border-radius: 8px; text-align: center; }
        .total-card h4 { font-size: 1rem; margin-bottom: 5px; font-weight: 600; }
        .total-card p { font-size: 1.5rem; font-weight: 700; color: var(--cor-principal); }
        .simulation-result { margin-top: 20px; text-align: center; }
        .simulation-result p { color: var(--cor-texto-secundario); font-size: 1rem; font-weight: 400; }
        .simulation-result h3 { font-size: 2.5rem; color: var(--cor-principal); margin-top: 5px; font-weight: 700; }
        
        /* ------------------- */
        /* COMPONENTES DA PÁGINA DE PRODUTOS */
        /* ------------------- */
        .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { text-align: left; padding: 12px; border-bottom: 1px solid var(--borda-card); }
        .data-table th { font-weight: 600; font-size: 0.9rem; color: var(--cor-texto-secundario); }
        .data-table td { font-size: 0.95rem; }
        .data-table .product-info { display: flex; align-items: center; gap: 15px; }
        .data-table .product-img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; background-color: #fce7f3; }
        .product-name { font-weight: 600; }
        .product-category { font-size: 0.85rem; color: var(--cor-texto-secundario); }
        .actions { display: flex; gap: 8px; }
        .stock-detail { font-size: 0.85rem; color: var(--cor-texto-secundario); display: block; }
        
        /* ------------------- */
        /* MODAIS E NOTIFICAÇÕES */
        /* ------------------- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background-color: var(--cor-fundo-card); border-radius: var(--borda-radius); padding: 30px; width: 100%; max-width: 700px; max-height: 90vh; overflow-y: auto; position: relative; animation: slideInUp 0.3s ease; }
        .modal-content.modal-sm { max-width: 500px; }
        @keyframes slideInUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--borda-card); padding-bottom: 15px; margin-bottom: 20px; }
        .modal-title { font-size: 1.5rem; font-weight: 700; }
        .close-modal { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: var(--cor-texto-secundario); }
        .form-section { border: 1px solid var(--borda-card); border-radius: 8px; padding: 20px; margin-top: 20px; }

        .app-notification { position: fixed; bottom: -100%; left: 20px; right: 20px; background-color: var(--cor-secundaria); color: var(--cor-texto); padding: 15px; border-radius: var(--borda-radius); box-shadow: 0 -4px 15px rgba(0,0,0,0.1); z-index: 3000; display: flex; align-items: center; justify-content: space-between; gap: 15px; transition: bottom 0.5s ease-in-out; }
        .app-notification.show { bottom: 20px; }
        .app-notification p { margin: 0; font-weight: 500; }
        
        /* Modal de Produto */
        .upload-area { border: 2px dashed #ddd; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; background-color: #f8fafc; margin-bottom: 15px; }
        .upload-area:hover { border-color: var(--cor-principal); }
        .slider-group { margin-top: 15px; }
        .slider-group label { margin-bottom: 10px; }
        .slider-container { display: flex; align-items: center; gap: 15px; }
        .slider-container input[type=range] { flex-grow: 1; -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: #fce7f3; border-radius: 5px; outline: none; }
        .slider-container input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: var(--cor-principal); border-radius: 50%; cursor: pointer; }
        .slider-value { font-weight: 600; min-width: 50px; text-align: right; }
        .price-suggestion { background-color: #fce7f3; border: 1px solid var(--borda-card); border-radius: 8px; padding: 15px; text-align: center; margin-top: 20px; }
        .price-suggestion p { margin: 0; color: var(--cor-texto-secundario); font-size: 0.9rem; }
        .price-suggestion h4 { font-size: 1.8rem; color: var(--cor-principal); margin-top: 5px; }
        .variation-type-selector { display: flex; gap: 10px; margin-bottom: 20px; }
        .variation-type-selector label { display: flex; align-items: center; gap: 8px; padding: 10px 15px; border-radius: 8px; border: 1px solid #ddd; cursor: pointer; flex-grow: 1; justify-content: center; }
        .variation-type-selector input[type="radio"]:checked + label { background-color: #fce7f3; border-color: var(--cor-principal); font-weight: 600; }
        .variation-type-selector input[type="radio"] { display: none; }
        .variation-container { display: none; }
        .variation-container.active { display: block; animation: fadeIn 0.3s; }
        .variation-row { display: grid; grid-template-columns: 1fr 100px 50px; gap: 10px; align-items: center; margin-bottom: 10px; }
        .variation-row.combined { grid-template-columns: 1fr 1fr 100px 50px; }
        .variation-header { display: grid; grid-template-columns: 1fr 100px 50px; gap: 10px; margin-bottom: 5px; font-size: 0.8rem; font-weight: 600; color: var(--cor-texto-secundario); padding: 0 5px; }
        .variation-header.combined { grid-template-columns: 1fr 1fr 100px 50px; }

        /* Componentes da Página de Vendas */
        .sale-item-list, .product-selection-list { list-style: none; margin-top: 15px; }
        .sale-item, .product-selection-item { display: flex; flex-direction: column; gap: 10px; padding: 10px; border-radius: 8px; margin-bottom: 10px; background-color: #fdf2f8; transition: background-color 0.2s; }
        .product-selection-item-header { display: flex; align-items: center; gap: 15px; width: 100%; cursor: pointer; }
        .product-selection-item-info { flex-grow: 1; }
        .sale-item-info { flex-grow: 1; display: flex; justify-content: space-between; align-items: center; width:100%; }
        .sale-item-details, .product-name-price-group { display: flex; flex-direction: column; }
        .sale-item-name { font-weight: 600; }
        .sale-item-sub-details { font-size: 0.85rem; color: var(--cor-texto-secundario); }
        .sale-item-total-price { font-weight: 500; }
        .sale-summary { margin-top: 20px; border-top: 1px solid var(--borda-card); padding-top: 15px; }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 1rem; }
        .summary-row.total { font-weight: 700; font-size: 1.2rem; color: var(--cor-principal); }
        .product-variation-selection { margin-top: 15px; padding-top: 15px; border-top: 1px dashed #fbcfe8; display: none; }
        .product-selection-item.expanded .product-variation-selection { display: block; }
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; color: var(--cor-texto-claro); }
        .status-badge.pago { background-color: var(--cor-sucesso); }
        .status-badge.pendente { background-color: var(--cor-alerta); }
        .discount-group { display: grid; grid-template-columns: 1fr 80px; gap: 10px; }
        .add-item-actions { display: grid; grid-template-columns: 1fr 1fr; gap:10px; align-items:center; }

        /* Componentes Fluxo de Caixa */
        .transaction-icon { width: 20px; height: 20px; margin-right: 8px; }
        .transaction-value.entrada { color: var(--cor-sucesso); }
        .transaction-value.saida { color: var(--cor-erro); }
        .card-content.positivo { color: var(--cor-sucesso); }
        .card-content.negativo { color: var(--cor-erro); }

        /* Componentes Liberdade Financeira */
        .priority-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; color: #fff; text-align: center;}
        .priority-badge.alta { background-color: var(--cor-erro); }
        .priority-badge.media { background-color: var(--cor-alerta); }
        .priority-badge.baixa { background-color: var(--cor-sucesso); }
        td .progress-bar-container { margin: 0; }
        td .progress-label { text-align: left; margin-top: 4px; }
        .quitacao-result { text-align: center; margin-top: 15px; background-color: #fdf2f8; padding: 15px; border-radius: 8px; }
        .quitacao-result p { font-size: 0.9rem; color: var(--cor-texto-secundario); }
        .quitacao-result strong { font-size: 1.5rem; color: var(--cor-principal); display: block; margin-top: 5px;}
        .quitacao-info { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; }
        .quitacao-info .value { font-weight: 600; color: var(--cor-principal); }
        .checkbox-group { display: flex; align-items: center; gap: 10px; padding: 10px; background-color: #fdf2f8; border-radius: 8px; cursor: pointer; }
        .checkbox-group input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--cor-principal); }

        /* Componentes Calculadoras */
        .calculator-result-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;}
        .calculator-result { padding: 10px; background-color: #fdf2f8; border-radius: 8px; text-align: center;}
        .calculator-result p { font-size: 0.9rem; color: var(--cor-texto-secundario); margin:0; }
        .calculator-result h4 { font-size: 1.5rem; color: var(--cor-principal); margin-top:5px;}
        .calculator-result-grid .calculator-result { background-color: transparent; padding: 0;}
        .calculator-result-grid .calculator-result p { text-align: left;}
        .calculator-result-grid .calculator-result h4 { text-align: left;}

        #reinvest-chart-container { display: flex; align-items: center; justify-content: center; margin-top: 20px; flex-wrap: wrap; gap: 20px;}
        #reinvest-pie-chart { width: 150px; height: 150px; border-radius: 50%; position: relative; }
        #reinvest-legend { list-style: none; padding-left: 20px; }
        
        .table-responsive-container {
            overflow-x: auto;
            position: relative;
        }

        /* ------------------- */
        /* RESPONSIVIDADE */
        /* ------------------- */
        @media (max-width: 768px) {
            .actions .btn-text {
                display: none;
            }
            .list-header .actions {
                width: 100%;
                justify-content: space-between;
            }
            .list-header .actions .btn-sm {
                flex-grow: 1;
            }
        }
        
        @media (min-width: 768px) { 
            .main-grid { grid-template-columns: repeat(2, 1fr); }
            .calculators-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (min-width: 1024px) {
            .main-grid { grid-template-columns: repeat(2, 1fr); } 
            .dashboard-grid { grid-template-columns: repeat(3, 1fr); }
            .calculators-grid { grid-template-columns: repeat(2, 1fr); }
            .side-menu { transform: translateX(0); }
            .main-container { margin-left: 280px; }
            .hamburger-menu { display: none; }
            body.menu-open .main-container { transform: translateX(0); }
            .overlay { display: none; }
        }
    </style>
</head>
<body>

    <svg width="0" height="0" style="display:none;">
        <symbol id="icon-info" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></symbol>
        <symbol id="icon-trash" viewBox="0 0 24 24"><path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></symbol>
        <symbol id="icon-edit" viewBox="0 0 24 24"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></symbol>
        <symbol id="icon-plus" viewBox="0 0 24 24"><path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></symbol>
        <symbol id="icon-upload" viewBox="0 0 24 24"><path fill="currentColor" d="M9 16h6v-6h4l-7-7-7 7h4v6zm-4 2h14v2H5v-2z"/></symbol>
        <symbol id="icon-dashboard" viewBox="0 0 24 24"><path fill="currentColor" d="M13 9V3h8v6h-8zM3 13V3h8v10H3zm10 8V11h8v10h-8zM3 21v-6h8v6H3z"/></symbol>
        <symbol id="icon-despesas" viewBox="0 0 24 24"><path fill="currentColor" d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c2.15-.45 3.5-1.66 3.5-3.6 0-2.03-1.12-3.12-4.2-3.99z"/></symbol>
        <symbol id="icon-produtos" viewBox="0 0 24 24"><path fill="currentColor" d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58.55 0 1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.55-.22-1.05-.59-1.42zM13 20.01L4 11V4h7l9 9-7 7.01z"/><circle cx="6.5" cy="6.5" r="1.5" fill="currentColor"/></symbol>
        <symbol id="icon-vendas" viewBox="0 0 24 24"><path fill="currentColor" d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zm10 0c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1z"/></symbol>
        <symbol id="icon-caixa" viewBox="0 0 24 24"><path fill="currentColor" d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></symbol>
        <symbol id="icon-arrow-up" viewBox="0 0 24 24"><path fill="currentColor" d="M7 14l5-5 5 5z"/></symbol>
        <symbol id="icon-arrow-down" viewBox="0 0 24 24"><path fill="currentColor" d="M7 10l5 5 5-5z"/></symbol>
        <symbol id="icon-calculadora" viewBox="0 0 24 24"><path fill="currentColor" d="M7 2h10v2h-2v2h2v2h-2v2h2v2h-2v2H7V2zm4 14h2v2h-2v-2zM7 18h10v2h-2v2h-2v-2h-2v2H9v-2H7v-2zM19 2H5v14h14V2zm-2 12H7V4h10v10z"/></symbol>
        <symbol id="icon-liberdade" viewBox="0 0 24 24"><path fill="currentColor" d="M16.5 10.5c-1.24 0-2.25 1.01-2.25 2.25s1.01 2.25 2.25 2.25 2.25-1.01 2.25-2.25-1.01-2.25-2.25-2.25zm4.5 2.25c0 3.59-2.91 6.5-6.5 6.5-3.59 0-6.5-2.91-6.5-6.5s2.91-6.5 6.5-6.5c1.56 0 2.98.56 4.11 1.48l1.42-1.42C18.6 4.73 16.68 4 14.5 4 9.26 4 5 8.26 5 13.5S9.26 23 14.5 23s9.5-4.26 9.5-9.5h-3zM3 13.5c0 .65.07 1.28.19 1.89L0 17.5l2.12 2.12 1.86-1.86C4.72 18.93 6.35 19.5 8 19.5V17c-1.08 0-2.09-.34-2.9-.92l-1.42 1.42L2.27 16.1l1.41-1.41C3.25 14.15 3 13.58 3 13.5H3z"/></symbol>
        <symbol id="icon-relatorios" viewBox="0 0 24 24"><path fill="currentColor" d="M8 10h8v2H8zm0-4h8v2H8zm4 8h4v2h-4zM20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></symbol>
        <symbol id="icon-ia" viewBox="0 0 24 24"><path fill="currentColor" d="M12 4c-4.42 0-8 3.58-8 8s3.58 8 8 8 8-3.58 8-8-3.58-8-8-8zm-2 13v-2h4v2H10zm5.1-4.9c-.3.3-.71.5-1.1.5s-.8-.2-1.1-.5l-.8-.8c-.3-.3-.5-.71-.5-1.1s.2-.8.5-1.1l.8-.8c.3-.3.71-.5 1.1-.5s.8.2 1.1.5l.8.8c.3.3.5.71.5 1.1s-.2.8-.5 1.1l-.8.8z"/></symbol>
        <symbol id="icon-perfil" viewBox="0 0 24 24"><path fill="currentColor" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></symbol>
        <symbol id="icon-logout" viewBox="0 0 24 24"><path fill="currentColor" d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></symbol>
        <symbol id="icon-hamburger" viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" fill="currentColor"/></symbol>
    </svg>

    <nav class="side-menu" id="side-menu">
        <div class="menu-header">
            <button class="close-menu-btn" id="close-menu-btn">&times;</button>
            <h2>C<span>4</span></h2> 
        </div>
        <ul class="menu-links">
            <li><a href="#" class="menu-link" data-target="dashboard"><svg class="icon"><use href="#icon-dashboard"/></svg>Dashboard</a></li>
            <li><a href="#" class="menu-link" data-target="despesas"><svg class="icon"><use href="#icon-despesas"/></svg>Despesas</a></li>
            <li><a href="#" class="menu-link" data-target="produtos"><svg class="icon"><use href="#icon-produtos"/></svg>Produtos</a></li>
            <li><a href="#" class="menu-link" data-target="vendas"><svg class="icon"><use href="#icon-vendas"/></svg>Vendas</a></li>
            <li><a href="#" class="menu-link" data-target="fluxo-caixa"><svg class="icon"><use href="#icon-caixa"/></svg>Fluxo de Caixa</a></li>
            <li><a href="#" class="menu-link" data-target="calculadoras"><svg class="icon"><use href="#icon-calculadora"/></svg>Calculadoras</a></li>
            <li><a href="#" class="menu-link" data-target="liberdade-financeira"><svg class="icon"><use href="#icon-liberdade"/></svg>Liberdade Financeira</a></li>
            <li><a href="#" class="menu-link" data-target="relatorios"><svg class="icon"><use href="#icon-relatorios"/></svg>Relatórios</a></li>
            <li><a href="#" class="menu-link" data-target="c4-ia"><svg class="icon"><use href="#icon-ia"/></svg>C4 IA</a></li>
            <li><a href="#" class="menu-link" data-target="perfil"><svg class="icon"><use href="#icon-perfil"/></svg>Perfil</a></li>
        </ul>
        <div style="padding: 20px; border-top: 1px solid rgba(255, 255, 255, 0.2);"><a href="#" style="color: white; text-decoration: none; display:flex; align-items:center; gap: 15px;"><svg class="icon"><use href="#icon-logout"/></svg>Sair</a></div>
    </nav>
    <div class="overlay" id="overlay"></div>

    <div class="main-container" id="main-container">
        <header class="app-header">
            <button class="hamburger-menu" id="hamburger-menu" aria-label="Abrir menu"><svg class="icon" style="color: white;"><use href="#icon-hamburger"/></svg></button>
            <h1 class="app-header-title">Dashboard</h1>
            <div class="header-actions"></div>
        </header>

        <main>
            <!-- PÁGINA DASHBOARD (ATUALIZADA) -->
            <section id="dashboard" class="page">
                <h2 class="page-title">Bem-vinda ao C4!</h2>
                <p class="page-subtitle">Seu painel financeiro para o sucesso.</p>
                <div class="quick-access-buttons">
                    <a href="#" class="quick-btn menu-link" data-target="vendas"><div class="icon"><svg><use href="#icon-vendas"/></svg></div><span>Nova Venda</span></a>
                    <a href="#" class="quick-btn menu-link" data-target="despesas"><div class="icon"><svg><use href="#icon-despesas"/></svg></div><span>Despesa</span></a>
                    <a href="#" class="quick-btn menu-link" data-target="produtos"><div class="icon"><svg><use href="#icon-produtos"/></svg></div><span>Produto</span></a>
                    <a href="#" class="quick-btn menu-link" data-target="fluxo-caixa"><div class="icon"><svg><use href="#icon-caixa"/></svg></div><span>Caixa</span></a>
                </div>
                <div class="dashboard-grid">
                    <div class="card"><h3 class="card-title">Faturamento do Mês</h3><p class="card-content" id="dashboard-faturamento">R$ 0,00</p></div>
                    <div class="card"><h3 class="card-title">Lucro Líquido do Mês</h3><p class="card-content" id="dashboard-lucro">R$ 0,00</p></div>
                    <div class="card"><h3 class="card-title">Pedidos no Mês</h3><p class="card-content" id="dashboard-pedidos">0</p></div>
                    <div class="card"><h3 class="card-title">Vendas por Produto</h3><div class="pie-chart-container"><div id="vendas-pie-chart" class="pie-chart"></div><ul id="vendas-legend" class="chart-legend"></ul></div></div>
                    <div class="card" id="card-meta-divida">
                        <h3 class="card-title">Meta: Quitar Dívidas</h3>
                        <div id="meta-divida-conteudo">
                            <!-- Conteúdo dinâmico aqui -->
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- PÁGINA DESPESAS (INTACTA) -->
            <section id="despesas" class="page">
                <h2 class="page-title">Controle de Despesas</h2>
                <p class="page-subtitle">Entenda seus custos para precificar corretamente.</p>
                <div class="main-grid">
                    <div class="card">
                        <h3 class="card-title">Custos Fixos <div class="info-tooltip"><svg class="icon"><use href="#icon-info"></use></svg><span class="tooltip-text">Custos que não mudam, independente de quanto você vende (ex: aluguel, internet).</span></div></h3>
                        <form id="form-custo-fixo">
                            <div class="form-group full-width"><label for="nome-custo-fixo">Nome do Custo</label><input type="text" id="nome-custo-fixo" placeholder="Ex: Aluguel" required></div>
                            <div class="form-grid">
                                <div class="form-group"><label for="valor-custo-fixo">Valor (R$)</label><input type="number" id="valor-custo-fixo" placeholder="1200.00" step="0.01" required></div>
                                <div class="form-group"><label for="data-vencimento-fixo">Vencimento</label><input type="date" id="data-vencimento-fixo" required></div>
                            </div>
                            <button type="submit" class="btn btn-primary">Adicionar Custo Fixo</button>
                        </form>
                        <ul class="costs-list" id="lista-custos-fixos"></ul>
                        <div class="total-card"><h4 >Total de Custos Fixos</h4><p id="total-custos-fixos">R$ 0,00</p></div>
                    </div>
                    
                    <div class="card">
                        <h3 class="card-title">Custos Variáveis <div class="info-tooltip"><svg class="icon"><use href="#icon-info"></use></svg><span class="tooltip-text">Custos que variam com suas vendas (ex: comissão, taxas de cartão).</span></div></h3>
                        <form id="form-custo-variavel">
                             <div class="form-group full-width"><label for="nome-custo-variavel">Nome do Custo</label><input type="text" id="nome-custo-variavel" placeholder="Ex: Comissão Vendedora" required></div>
                             <div class="form-grid">
                                 <div class="form-group"><label for="valor-custo-variavel">Valor</label><input type="number" id="valor-custo-variavel" placeholder="10" step="0.01" required></div>
                                 <div class="form-group"><label for="tipo-custo-variavel">Tipo</label><select id="tipo-custo-variavel"><option value="percent">%</option><option value="real">R$</option></select></div>
                             </div>
                             <button type="submit" class="btn btn-primary">Adicionar Custo Variável</button>
                        </form>
                        <ul class="costs-list" id="lista-custos-variaveis"></ul>
                        <div class="total-card"><h4 >Total Variável (em R$)</h4><p id="total-custos-variaveis">R$ 0,00</p></div>
                    </div>

                    <div class="card" style="grid-column: 1 / -1;">
                        <h3 class="card-title">Simulação e Custo Unitário</h3>
                        <div class="main-grid">
                             <div>
                                <div class="form-group"><label for="valor-frete">Soma dos Fretes do Mês (R$)</label><input type="number" id="valor-frete" class="calculator-input" placeholder="Ex: 85.00" step="0.01"></div>
                                <div class="form-group"><label for="valor-impostos">Imposto sobre Venda (%)</label><input type="number" id="valor-impostos" class="calculator-input" placeholder="Ex: 4 (para MEI)" step="0.01"></div>
                             </div>
                             <div>
                                <div class="form-group"><label for="meta-vendas">Quantas peças você estima vender por mês?</label><input type="number" id="meta-vendas" class="calculator-input" placeholder="Ex: 100" required></div>
                                <div class="simulation-result" style="margin-top:0; padding: 10px; background-color:#fdf2f8; border-radius: 8px;">
                                    <p>Custo por Unidade Vendida</p>
                                    <h3 id="custo-unitario-final" style="margin-top:0;">R$ 0,00</h3>
                                </div>
                             </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- PÁGINA PRODUTOS (INTACTA) -->
            <section id="produtos" class="page">
                <h2 class="page-title">Gestão de Produtos</h2>
                <p class="page-subtitle">Cadastre e organize seus produtos e suas variações.</p>
                <div class="dashboard-grid">
                     <div class="card"><h3 class="card-title">Mais em Estoque</h3><p class="card-content" id="prod-mais-estoque">Bolsa Couro</p><span class="detail" id="prod-mais-estoque-qtd">50 unidades</span></div>
                     <div class="card"><h3 class="card-title">Mais Vendido</h3><p class="card-content" id="prod-mais-vendido">Sandália Nude</p><span class="detail">25 vendas</span></div>
                     <div class="card"><h3 class="card-title">Produtos Ativos</h3><p class="card-content" id="prod-ativos-total">3</p><span class="detail">Total cadastrado</span></div>
                </div>
                <div class="card">
                     <div class="list-header">
                        <h3 class="card-title" style="margin-bottom:0;">Meus Produtos</h3>
                        <button class="btn btn-primary" id="btn-novo-produto"><svg class="icon"><use href="#icon-plus"/></svg>Novo Produto</button>
                    </div>
                    <div class="table-responsive-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Preço Venda</th>
                                    <th>Estoque Total</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-produtos"></tbody>
                        </table>
                    </div>
                </div>
            </section>
            
            <!-- PÁGINA DE VENDAS (INTACTA) -->
            <section id="vendas" class="page">
                <h2 class="page-title">Gestão de Vendas</h2>
                <p class="page-subtitle">Registre suas vendas e acompanhe seu faturamento.</p>

                <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                     <div class="card"><h3 class="card-title">Pedidos no Mês</h3><p class="card-content" id="vendas-pedidos-mes">0</p></div>
                     <div class="card"><h3 class="card-title">Faturamento Bruto</h3><p class="card-content" id="vendas-faturamento-bruto">R$ 0,00</p></div>
                     <div class="card"><h3 class="card-title">Lucro Líquido</h3><p class="card-content" id="vendas-lucro-liquido">R$ 0,00</p></div>
                     <div class="card"><h3 class="card-title">Item Mais Vendido</h3><p class="card-content" id="vendas-item-mais-vendido">N/A</p></div>
                </div>

                <div class="card">
                     <div class="list-header">
                        <h3 class="card-title" style="margin-bottom:0;">Vendas Recentes</h3>
                        <button class="btn btn-primary" id="btn-nova-venda"><svg class="icon"><use href="#icon-vendas"/></svg>Nova Venda</button>
                    </div>
                    <div class="table-responsive-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Itens</th>
                                    <th>Valor Total</th>
                                    <th>Data</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="lista-vendas"></tbody>
                        </table>
                    </div>
                </div>
            </section>
            
            <!-- PÁGINA FLUXO DE CAIXA (INTACTA) -->
            <section id="fluxo-caixa" class="page">
                <h2 class="page-title">Fluxo de Caixa</h2>
                <p class="page-subtitle">Acompanhe as entradas e saídas do seu negócio.</p>
                <div class="dashboard-grid">
                    <div class="card"><h3 class="card-title">Saldo Atual</h3><p class="card-content" id="caixa-saldo-atual">R$ 0,00</p></div>
                    <div class="card"><h3 class="card-title">Total de Entradas</h3><p class="card-content positivo" id="caixa-total-entradas">R$ 0,00</p></div>
                    <div class="card"><h3 class="card-title">Total de Saídas</h3><p class="card-content negativo" id="caixa-total-saidas">R$ 0,00</p></div>
                </div>
                 <div class="card">
                     <div class="list-header">
                        <h3 class="card-title" style="margin-bottom:0;">Lançamentos Recentes</h3>
                        <button class="btn btn-danger" id="btn-nova-saida"><svg class="icon"><use href="#icon-arrow-down"/></svg>Registrar Saída</button>
                    </div>
                    <div class="table-responsive-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Descrição</th>
                                    <th>Valor</th>
                                </tr>
                            </thead>
                            <tbody id="lista-transacoes-caixa"></tbody>
                        </table>
                    </div>
                </div>
            </section>

             <!-- PÁGINA LIBERDADE FINANCEIRA (INTACTA) -->
            <section id="liberdade-financeira" class="page">
                <h2 class="page-title">Liberdade Financeira</h2>
                <p class="page-subtitle">Organize e planeje a quitação das suas dívidas.</p>
                <div class="dashboard-grid">
                    <div class="card"><h3 class="card-title">Total a Quitar</h3><p class="card-content" id="lf-total-dividas">R$ 0,00</p></div>
                    <div class="card"><h3 class="card-title">Maior Dívida</h3><p class="card-content" id="lf-maior-divida">N/A</p><span class="detail" id="lf-maior-divida-valor"></span></div>
                    <div class="card"><h3 class="card-title">Progresso Geral</h3>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="background-color: var(--cor-sucesso);"><div id="lf-progresso-geral" class="progress" style="background-color: var(--cor-principal);"></div></div>
                            <p class="progress-label" id="lf-progresso-geral-label">0% quitado</p>
                        </div>
                    </div>
                </div>
                 <div class="card" style="margin-bottom: 20px;">
                    <div class="list-header">
                        <h3 class="card-title" style="margin-bottom:0;">Minhas Dívidas</h3>
                        <div class="actions">
                            <button class="btn btn-secondary btn-sm menu-link" data-target="planejamento-quitacao"><span class="btn-text">Planejar Quitação</span><svg class="icon icon-only"><use href="#icon-calculadora"/></svg></button>
                            <button class="btn btn-primary btn-sm" id="btn-adicionar-divida"><span class="btn-text">Adicionar</span><svg class="icon icon-only"><use href="#icon-plus"/></svg></button>
                        </div>
                    </div>
                    <div class="table-responsive-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Descrição da Dívida</th>
                                    <th>Valor Restante</th>
                                    <th>Progresso</th>
                                    <th>Prioridade</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-dividas"></tbody>
                        </table>
                    </div>
                </div>
            </section>

             <!-- PÁGINA PLANEJAMENTO QUITAÇÃO (INTACTA) -->
            <section id="planejamento-quitacao" class="page">
                 <h2 class="page-title">Planejar Quitação</h2>
                 <p class="page-subtitle">Defina sua estratégia para alcançar a liberdade financeira.</p>

                 <div class="form-group full-width">
                     <label for="planejamento-selecionar-divida">Selecione a Dívida para Planejar</label>
                     <select id="planejamento-selecionar-divida"></select>
                 </div>

                 <div class="main-grid" id="planejamento-container" style="display: none;">
                     <div class="card">
                        <h3 class="card-title">Defina sua Estratégia</h3>
                        <div class="quitacao-info">
                            <span>Dívida Selecionada:</span>
                            <span class="value" id="plan-divida-nome"></span>
                        </div>
                        <div class="quitacao-info" style="margin-top: 5px;">
                            <span>Valor Total:</span>
                            <span class="value" id="plan-divida-valor-total"></span>
                        </div>
                        <hr style="border: 0; border-top: 1px solid var(--borda-card); margin: 15px 0;">
                        <div class="form-group">
                            <label for="plan-poupanca-valor">Quanto você pode poupar?</label>
                            <input type="number" id="plan-poupanca-valor" placeholder="50.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="plan-poupanca-freq">Com qual frequência?</label>
                            <select id="plan-poupanca-freq">
                                <option value="dia">por Dia</option>
                                <option value="semana">por Semana</option>
                                <option value="quinzena">por Quinzena</option>
                                <option value="mes">por Mês</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="plan-valor-ja-pago">Valor já pago/disponível para esta dívida (R$):</label>
                             <input type="number" id="plan-valor-ja-pago" placeholder="0.00" step="0.01">
                        </div>
                        <div class="actions" style="gap:15px; margin-top:10px;">
                            <button type="button" id="btn-calcular-tempo" class="btn btn-secondary">Calcular Tempo</button>
                            <button type="button" id="btn-criar-meta" class="btn btn-primary">Criar Meta no App</button>
                        </div>
                     </div>
                      <div class="card">
                        <h3 class="card-title">Sua Meta de Quitação</h3>
                        <p style="font-size: 1rem; text-align:center;">Dívida: <strong id="meta-divida-nome" style="color:var(--cor-principal)"></strong></p>
                        <div class="progress-bar-container" style="margin: 20px 0;">
                            <div class="progress-bar"><div class="progress" id="meta-progresso-barra"></div></div>
                        </div>
                        <div class="summary-row"><span>Total da Dívida:</span><strong id="meta-valor-total">R$ 0,00</strong></div>
                        <div class="summary-row"><span>Valor Já Pago/Guardado:</span><strong id="meta-valor-pago">R$ 0,00</strong></div>
                        <div class="summary-row" style="color:var(--cor-erro);"><span>Falta para Quitar:</span><strong id="meta-valor-restante">R$ 0,00</strong></div>
                        <div id="meta-tempo-resultado" class="quitacao-result" style="display: none; margin-top: 25px;">
                            <p>Tempo estimado para quitação:</p>
                            <strong id="meta-tempo-estimado">...</strong>
                        </div>
                     </div>
                     <div class="card" style="grid-column: 1 / -1;">
                        <h3 class="card-title">💡 Ideias para Acelerar</h3>
                        <p class="page-subtitle" style="margin-bottom:0;">Para quitar sua dívida, você precisaria vender aproximadamente:</p>
                        <p id="ideias-acelerar-texto" style="margin-top:10px;">Selecione uma dívida e calcule para ver as ideias.</p>
                     </div>
                 </div>
            </section>

            <!-- PÁGINA CALCULADORAS (ATUALIZADA) -->
            <section id="calculadoras" class="page active">
                <h2 class="page-title">Calculadoras Inteligentes</h2>
                <p class="page-subtitle">Ferramentas rápidas para decisões financeiras mais assertivas.</p>

                <div class="main-grid calculators-grid">
                     <div class="card">
                        <h3 class="card-title">Simulador do Lucro Certo</h3>
                         <div class="form-group">
                            <label for="calc-lc-custo">Custo do Produto (R$)</label>
                            <input type="number" id="calc-lc-custo" class="calculator-input" placeholder="50.00" step="0.01">
                        </div>
                         <div class="form-group">
                            <label for="calc-lc-despesas">Despesas por Unidade (R$)</label>
                            <input type="number" id="calc-lc-despesas" class="calculator-input" readonly>
                        </div>
                        <div class="form-group slider-group">
                            <label for="calc-lc-margem">Margem de Lucro Desejada</label>
                            <div class="slider-container">
                                <input type="range" id="calc-lc-margem" class="calculator-input" min="0" max="95" value="50">
                                <span class="slider-value" id="calc-lc-margem-valor">50%</span>
                            </div>
                        </div>
                        <div class="calculator-result">
                            <p>Preço de Venda Sugerido</p>
                            <h4 id="calc-lc-preco-venda">R$ 0,00</h4>
                        </div>
                        <div class="calculator-result" style="margin-top:10px;">
                            <p>Lucro Bruto por Venda</p>
                            <h4 id="calc-lc-lucro-bruto">R$ 0,00</h4>
                        </div>
                    </div>
                     <div class="card">
                        <h3 class="card-title">Calculadora de Promoções</h3>
                        <div class="form-group">
                            <label for="calc-promo-produto">Selecione o Produto</label>
                            <select id="calc-promo-produto" class="calculator-input"></select>
                         </div>
                         <div class="form-grid">
                             <div class="form-group">
                                <label for="calc-promo-preco-atual">Preço Atual</label>
                                <input type="text" id="calc-promo-preco-atual" readonly>
                            </div>
                             <div class="form-group">
                                <label for="calc-promo-custo">Custo</label>
                                <input type="text" id="calc-promo-custo" readonly>
                            </div>
                         </div>
                         <div class="form-group">
                            <label for="calc-promo-desconto">Desconto Desejado (%)</label>
                            <input type="number" id="calc-promo-desconto" class="calculator-input" placeholder="15" step="1">
                        </div>
                         <div class="calculator-result">
                            <p>Novo Preço de Venda</p>
                            <h4 id="calc-promo-novo-preco">R$ 0,00</h4>
                        </div>
                        <div class="calculator-result-grid">
                            <div class="calculator-result">
                                <p>Novo Lucro</p>
                                <h4 id="calc-promo-novo-lucro">R$ 0,00</h4>
                            </div>
                            <div class="calculator-result">
                                <p>Nova Margem</p>
                                <h4 id="calc-promo-nova-margem">0%</h4>
                            </div>
                        </div>
                    </div>
                     <div class="card" style="grid-column: 1 / -1;">
                        <h3 class="card-title">Calculadora de Distribuição de Lucro</h3>
                        <div class="form-group full-width">
                            <label for="calc-reinvest-lucro">Lucro Líquido do Período (R$)</label>
                            <input type="number" id="calc-reinvest-lucro" readonly>
                        </div>

                        <div id="reinvest-chart-container">
                             <div id="reinvest-pie-chart" class="pie-chart"></div>
                             <div id="reinvest-legend" class="chart-legend"></div>
                        </div>
                        
                        <div class="form-grid" style="margin-top: 20px;">
                            <div class="form-group slider-group">
                                <label for="perc-reinvestimento">Reinvestimento</label>
                                <div class="slider-container">
                                    <input type="range" id="perc-reinvestimento" class="dist-slider" min="0" max="100" value="30">
                                    <span class="slider-value">30%</span>
                                </div>
                            </div>
                             <div class="form-group slider-group">
                                <label for="perc-dividas">Quitar Dívidas</label>
                                <div class="slider-container">
                                    <input type="range" id="perc-dividas" class="dist-slider" min="0" max="100" value="30">
                                    <span class="slider-value">30%</span>
                                </div>
                            </div>
                             <div class="form-group slider-group">
                                <label for="perc-reserva">Reserva de Emergência</label>
                                <div class="slider-container">
                                    <input type="range" id="perc-reserva" class="dist-slider" min="0" max="100" value="20">
                                    <span class="slider-value">20%</span>
                                </div>
                            </div>
                             <div class="form-group slider-group">
                                <label for="perc-pessoal">Retirada Pessoal</label>
                                <div class="slider-container">
                                    <input type="range" id="perc-pessoal" class="dist-slider" min="0" max="100" value="20">
                                    <span class="slider-value">20%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="card-title">Calculadora de Frete Grátis</h3>
                         <div class="form-group">
                            <label for="calc-frete-custo">Custo Médio do Frete (R$)</label>
                            <input type="number" id="calc-frete-custo" class="calculator-input" placeholder="25.00" step="0.01">
                        </div>
                         <div class="form-group">
                            <label for="calc-frete-margem">Sua Margem de Lucro Média (%)</label>
                            <input type="number" id="calc-frete-margem" class="calculator-input" placeholder="40" step="1">
                        </div>
                        <div class="calculator-result">
                            <p>Valor Mínimo de Compra</p>
                            <h4 id="calc-frete-resultado">R$ 0,00</h4>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="relatorios" class="page">
                <h2 class="page-title">Relatórios</h2>
                 <p class="page-subtitle">Analise o desempenho do seu negócio em detalhes.</p>
                <div class="card">
                    <div class="list-header">
                         <div class="form-grid" style="flex-grow: 1;">
                            <div class="form-group" style="margin-bottom:0;">
                                <label for="relatorio-data-inicio">Data de Início</label>
                                <input type="date" id="relatorio-data-inicio">
                            </div>
                             <div class="form-group" style="margin-bottom:0;">
                                <label for="relatorio-data-fim">Data de Fim</label>
                                <input type="date" id="relatorio-data-fim">
                            </div>
                        </div>
                        <button class="btn btn-primary" id="btn-gerar-relatorio" style="align-self:end;">Gerar Relatório</button>
                    </div>
                </div>

                <div id="relatorio-container" style="display: none;">
                    <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                        <div class="card"><h3 class="card-title">Faturamento Bruto</h3><p class="card-content" id="relatorio-faturamento"></p></div>
                        <div class="card"><h3 class="card-title">Lucro Líquido</h3><p class="card-content" id="relatorio-lucro"></p></div>
                        <div class="card"><h3 class="card-title">Total de Despesas</h3><p class="card-content" id="relatorio-despesas"></p></div>
                        <div class="card"><h3 class="card-title">Vendas no Período</h3><p class="card-content" id="relatorio-num-vendas"></p></div>
                    </div>

                    <div class="card" style="margin-top: 20px;">
                        <div class="list-header">
                            <h3 class="card-title" style="margin-bottom:0;">Vendas por Período</h3>
                            <div class="actions">
                                <button class="btn btn-secondary btn-sm" id="export-vendas-pdf"><svg class="icon"><use href="#icon-relatorios"/></svg>Exportar PDF</button>
                            </div>
                        </div>
                         <div class="table-responsive-container"><table class="data-table"><thead><tr><th>Data</th><th>Cliente</th><th>Total</th></tr></thead><tbody id="relatorio-vendas-table"></tbody></table></div>
                    </div>
                     <div class="card" style="margin-top: 20px;">
                        <div class="list-header">
                            <h3 class="card-title" style="margin-bottom:0;">Despesas por Período</h3>
                             <div class="actions">
                                <button class="btn btn-secondary btn-sm" id="export-despesas-pdf"><svg class="icon"><use href="#icon-relatorios"/></svg>Exportar PDF</button>
                            </div>
                        </div>
                         <div class="table-responsive-container"><table class="data-table"><thead><tr><th>Data</th><th>Descrição</th><th>Valor</th></tr></thead><tbody id="relatorio-despesas-table"></tbody></table></div>
                    </div>
                    <div class="card" style="margin-top: 20px;">
                        <div class="list-header">
                            <h3 class="card-title" style="margin-bottom:0;">Produtos Mais Rentáveis</h3>
                             <div class="actions">
                                <button class="btn btn-secondary btn-sm" id="export-produtos-pdf"><svg class="icon"><use href="#icon-relatorios"/></svg>Exportar PDF</button>
                            </div>
                        </div>
                         <div class="table-responsive-container"><table class="data-table"><thead><tr><th>Produto</th><th>Unidades Vendidas</th><th>Lucro Total Gerado</th></tr></thead><tbody id="relatorio-produtos-rentaveis-table"></tbody></table></div>
                    </div>

                </div>
            </section>
            
            <section id="c4-ia" class="page"><h2 class="page-title">C4 IA</h2></section>
            <section id="perfil" class="page"><h2 class="page-title">Perfil</h2></section>
        </main>
    </div>

    <!-- MODAL DE CADASTRO DE PRODUTO (INTACTO) -->
    <div class="modal" id="modal-produto">
        <div class="modal-content">
            <div class="modal-header"> <h3 class="modal-title" id="modal-produto-titulo">Novo Produto</h3> <button class="close-modal" data-modal="modal-produto">&times;</button> </div>
            <form id="form-produto"> <input type="hidden" id="produto-id"> <div class="upload-area" id="upload-area"> <svg class="icon" style="width:40px; height:40px; color: var(--cor-texto-secundario); margin-bottom:10px;"><use href="#icon-upload"/></svg> <p>Clique para enviar uma foto</p> <input type="file" id="foto-produto" accept="image/*" style="display:none;"> <img id="preview-foto" src="" alt="Preview da foto" style="max-width: 100px; max-height: 100px; display: none; margin-top: 10px; border-radius: 8px;"> </div> <div class="form-group full-width"> <label for="nome-produto">Nome do Produto</label> <input type="text" id="nome-produto" required placeholder="Ex: Bolsa de Couro Luxo"> </div> <div class="form-grid"> <div class="form-group"> <label for="custo-produto">Custo do Produto (R$)</label> <input type="number" step="0.01" id="custo-produto" required placeholder="55.00"> </div> <div class="form-group"> <label for="categoria-produto">Categoria</label> <select id="categoria-produto" required> <option value="bolsa">Bolsa</option> <option value="calcado">Calçado</option> <option value="roupa">Roupa</option> <option value="perfumaria">Perfumaria</option> <option value="maquiagem">Maquiagem</option> <option value="skincare">Skincare</option> <option value="acessorio">Acessório</option> </select> </div> </div> <div class="form-section"> <label>Estoque e Variações</label> <div class="variation-type-selector"> <input type="radio" name="variation-type" id="type-none" value="none" checked> <label for="type-none">Produto Único</label> <input type="radio" name="variation-type" id="type-simple" value="simple"> <label for="type-simple">Variação Simples</label> <input type="radio" name="variation-type" id="type-combined" value="combined"> <label for="type-combined">Variação Combinada</label> </div> <div id="container-no-variation" class="variation-container active"> <div class="form-group full-width"> <label for="estoque-produto">Quantidade em Estoque</label> <input type="number" id="estoque-produto" placeholder="50"> </div> </div> <div id="container-simple-variation" class="variation-container"> <div class="form-group full-width"> <label for="simple-variation-name">Nome da Variação (Ex: Tamanho)</label> <input type="text" id="simple-variation-name" placeholder="Tamanho"> </div> <div id="simple-variation-header" class="variation-header" style="display: none;"> <span>Valor da Variação</span> <span>Estoque</span> <span></span> </div> <div id="simple-variation-list"></div> <button type="button" id="add-simple-variation-btn" class="btn btn-secondary btn-sm" style="width: auto; margin-top: 10px;">Adicionar Variação</button> </div> <div id="container-combined-variation" class="variation-container"> <div class="form-grid"> <div class="form-group"> <label for="combined-variation-name1">Atributo 1 (Ex: Cor)</label> <input type="text" id="combined-variation-name1" placeholder="Cor"> </div> <div class="form-group"> <label for="combined-variation-values1">Valores (separados por vírgula)</label> <input type="text" id="combined-variation-values1" placeholder="Preto, Nude, Branco"> </div> </div> <div class="form-grid"> <div class="form-group"> <label for="combined-variation-name2">Atributo 2 (Ex: Tamanho)</label> <input type="text" id="combined-variation-name2" placeholder="Tamanho"> </div> <div class="form-group"> <label for="combined-variation-values2">Valores (separados por vírgula)</label> <input type="text" id="combined-variation-values2" placeholder="34, 35, 36"> </div> </div> <button type="button" id="generate-combinations-btn" class="btn btn-secondary" style="margin-bottom: 20px;">Gerar Combinações</button> <div id="combined-variation-header" class="variation-header combined" style="display: none;"> <span id="header-attr1">Atributo 1</span> <span id="header-attr2">Atributo 2</span> <span>Estoque</span> <span></span> </div> <div id="combined-variation-list"></div> </div> </div> <div class="form-section"> <label>Precificação Inteligente</label> <div class="form-grid"> <div class="form-group"> <label for="custo-unitario-despesa" style="font-size:0.8rem; color: var(--cor-texto-secundario)">+ Custo Unitário (Despesas)</label> <input type="text" id="custo-unitario-despesa" readonly> </div> <div class="form-group"> <label for="custo-total-produto" style="font-size:0.8rem; color: var(--cor-texto-secundario)">= Custo Total do Produto</label> <input type="text" id="custo-total-produto" readonly> </div> </div> <div class="form-group full-width slider-group"> <label for="margem-lucro">Margem de Lucro Desejada</label> <div class="slider-container"> <input type="range" id="margem-lucro" min="0" max="500" value="100"> <span class="slider-value" id="margem-lucro-valor">100%</span> </div> </div> <div class="price-suggestion"> <p>Preço de Venda Sugerido</p> <h4 id="preco-sugerido">R$ 0,00</h4> </div> </div> <div class="form-group full-width" style="margin-top: 30px; display:flex; gap: 15px;"> <button type="button" class="btn btn-secondary" data-modal="modal-produto">Cancelar</button> <button type="submit" class="btn btn-primary">Salvar Produto</button> </div> </form>
        </div>
    </div>

    <!-- MODAL DE NOVA VENDA (INTACTO) -->
    <div class="modal" id="modal-venda">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-venda-titulo">Registrar Nova Venda</h3>
                <button class="close-modal" data-modal="modal-venda">&times;</button>
            </div>
            <form id="form-venda">
                <input type="hidden" id="venda-id">

                <div class="form-section">
                    <h3 class="card-title" style="margin-bottom:20px; font-size: 1.1rem;">Dados do Cliente</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="venda-cliente-nome">Nome do Cliente</label>
                            <input type="text" id="venda-cliente-nome" placeholder="Nome completo" required>
                        </div>
                        <div class="form-group">
                            <label for="venda-cliente-telefone">Telefone</label>
                            <input type="tel" id="venda-cliente-telefone" placeholder="(XX) XXXXX-XXXX">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="list-header">
                        <h3 class="card-title" style="margin-bottom:0; font-size: 1.1rem;">Itens da Venda</h3>
                        <button type="button" class="btn btn-secondary btn-sm" id="btn-adicionar-item-venda">Adicionar Produto</button>
                    </div>
                    <ul class="sale-item-list" id="sale-item-list">
                       <!-- Itens adicionados à venda aparecerão aqui -->
                       <p style="text-align: center; color: var(--cor-texto-secundario); padding: 10px 0;">Nenhum produto adicionado.</p>
                    </ul>
                    <div class="sale-summary" id="sale-summary" style="display: none;">
                        <div class="summary-row">
                            <span>Subtotal</span>
                            <span id="sale-subtotal">R$ 0,00</span>
                        </div>
                         <div class="form-grid" style="align-items: flex-end; margin-top: 15px;">
                            <div class="form-group discount-group" style="margin-bottom:0; grid-column: 1 / -1; display:grid; grid-template-columns: 1fr 100px; gap:10px;">
                                <div>
                                    <label for="sale-discount-value">Desconto</label>
                                    <input type="number" id="sale-discount-value" step="0.01" placeholder="0.00">
                                </div>
                                <div>
                                    <label for="sale-discount-type">Tipo</label>
                                    <select id="sale-discount-type">
                                        <option value="real">R$</option>
                                        <option value="percent">%</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom:0; grid-column: 1 / -1;">
                                <label for="sale-payment">Forma de Pagamento</label>
                                <select id="sale-payment">
                                    <option value="pix">PIX</option>
                                    <option value="dinheiro">Dinheiro</option>
                                    <option value="credito">Cartão de Crédito</option>
                                    <option value="debito">Cartão de Débito</option>
                                </select>
                            </div>
                        </div>
                        <div class="summary-row total" style="margin-top: 15px;">
                            <span>TOTAL</span>
                            <span id="sale-total">R$ 0,00</span>
                        </div>
                    </div>
                </div>
                
                <div class="form-group full-width" style="margin-top: 30px; display:flex; gap: 15px;">
                    <button type="button" class="btn btn-secondary" data-modal="modal-venda">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Finalizar Venda</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- MODAL DE SELEÇÃO DE PRODUTO PARA VENDA (INTACTO) -->
    <div class="modal" id="modal-selecionar-produto">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h3 class="modal-title">Selecionar Produto</h3>
                <button class="close-modal" data-modal="modal-selecionar-produto">&times;</button>
            </div>
            <div id="product-selection-list" class="product-selection-list">
                 <!-- Lista de produtos para seleção -->
            </div>
        </div>
    </div>

    <!-- MODAL DE NOVA SAÍDA DE CAIXA (INTACTO) -->
     <div class="modal" id="modal-saida-caixa">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h3 class="modal-title">Registrar Saída Manual</h3>
                <button class="close-modal" data-modal="modal-saida-caixa">&times;</button>
            </div>
            <form id="form-saida-caixa">
                <div class="form-group full-width">
                    <label for="saida-descricao">Descrição</label>
                    <input type="text" id="saida-descricao" placeholder="Ex: Compra de material" required>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="saida-valor">Valor (R$)</label>
                        <input type="number" step="0.01" id="saida-valor" placeholder="150.00" required>
                    </div>
                    <div class="form-group">
                        <label for="saida-data">Data</label>
                        <input type="date" id="saida-data" required>
                    </div>
                </div>
                <div class="form-group full-width" style="margin-top: 15px; display:flex; gap: 15px;">
                    <button type="button" class="btn btn-secondary" data-modal="modal-saida-caixa">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Registrar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- MODAL DE NOVA DÍVIDA (ATUALIZADO) -->
    <div class="modal" id="modal-divida">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-divida-titulo">Adicionar Nova Dívida</h3>
                <button class="close-modal" data-modal="modal-divida">&times;</button>
            </div>
            <form id="form-divida">
                <input type="hidden" id="divida-id">
                <div class="form-group full-width">
                    <label for="divida-nome">Nome da Dívida</label>
                    <input type="text" id="divida-nome" placeholder="Ex: Cartão de Crédito Nubank" required>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="divida-valor-total">Valor Total (R$)</label>
                        <input type="number" step="0.01" id="divida-valor-total" placeholder="5000.00" required>
                    </div>
                    <div class="form-group">
                        <label for="divida-valor-pago">Valor já Pago (R$)</label>
                        <input type="number" step="0.01" id="divida-valor-pago" placeholder="1000.00" required>
                    </div>
                </div>
                <div class="form-group full-width">
                    <label for="divida-vencimento">Próximo Vencimento</label>
                    <input type="date" id="divida-vencimento" required>
                </div>
                 <div class="form-group full-width">
                    <label>Possui parcelamento?</label>
                    <div class="variation-type-selector">
                        <input type="radio" name="divida-tem-parcelas" id="parcelas-nao" value="nao" checked>
                        <label for="parcelas-nao">Não</label>
                        <input type="radio" name="divida-tem-parcelas" id="parcelas-sim" value="sim">
                        <label for="parcelas-sim">Sim</label>
                    </div>
                </div>
                <div id="container-parcelas" style="display: none;">
                    <div class="form-group full-width">
                        <label for="divida-parcelas-faltam">Quantas parcelas faltam?</label>
                        <input type="number" id="divida-parcelas-faltam" placeholder="12">
                    </div>
                </div>
                <div class="form-group full-width">
                     <label for="divida-prioridade">Prioridade de Quitação</label>
                     <select id="divida-prioridade" required>
                         <option value="baixa">Baixa</option>
                         <option value="media">Média</option>
                         <option value="alta">Alta</option>
                     </select>
                </div>
                 <div class="form-group full-width" style="margin-top: 15px; display:flex; gap: 15px;">
                    <button type="button" class="btn btn-secondary" data-modal="modal-divida">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Dívida</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="app-notification" class="app-notification">
        <p id="notification-text"></p>
        <button id="notification-close" class="close-modal" style="color: var(--cor-texto)">&times;</button>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            'use strict';
            // --- SELETORES GERAIS ---
            const hamburgerMenu = document.getElementById('hamburger-menu');
            const sideMenu = document.getElementById('side-menu');
            const overlay = document.getElementById('overlay');
            const appHeaderTitle = document.querySelector('.app-header-title');
            const mainElement = document.querySelector('main');
            const closeModalButtons = document.querySelectorAll('.close-modal');
            const closeMenuBtn = document.getElementById('close-menu-btn');


            // --- ESTADO DA APLICAÇÃO ---
            let custosFixos = [];
            let custosVariaveis = [];
            let produtos = [];
            let vendas = [];
            let fluxoCaixa = [];
            let dividas = [];
            let planoQuitacaoAtivo = {}; 
            let metaDiariaConcluida = { data: null };
            let custoUnitarioGlobal = 0.0;
            let currentSaleItems = []; 

            // --- FUNÇÕES DE UTILIDADE ---
            const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
            const formatDate = (dateString) => { const date = new Date(dateString); const day = String(date.getUTCDate()).padStart(2, '0'); const month = String(date.getUTCMonth() + 1).padStart(2, '0'); const year = date.getUTCFullYear(); return `${day}/${month}/${year}`; };
            const parseCurrency = (value) => { if(typeof value !== 'string') return Number(value) || 0; return Number(value.replace(/[^0-9,-]+/g,"").replace(",", ".")) || 0; };
            const getTodayString = () => new Date().toISOString().split('T')[0];

            // --- LÓGICA DE NAVEGAÇÃO E MODAIS ---
            function openModal(modalId) { const modal = document.getElementById(modalId); if(modal) modal.classList.add('active'); }
            function closeModal(modalId) { const modal = document.getElementById(modalId); if(modal) modal.classList.remove('active'); }
            closeModalButtons.forEach(btn => btn.addEventListener('click', () => {
                const modalId = btn.closest('.modal')?.id;
                if(modalId) closeModal(modalId);
            }));
            
            function toggleMenu() {
                sideMenu.classList.toggle('active');
                overlay.classList.toggle('active');
            }

            function showPage(pageId, pushState = true) {
                if (pageId === 'planejamento-quitacao') {
                    popularDropdownDividas();
                    const container = document.getElementById('planejamento-container');
                    if (container) container.style.display = 'none';
                    if (planejamentoSelectDivida) planejamentoSelectDivida.value = '';
                    const resultadoEl = document.getElementById('meta-tempo-resultado');
                    if(resultadoEl) resultadoEl.style.display = 'none';
                } else if(pageId === 'calculadoras') {
                    setupCalculadoras();
                } else if (pageId === 'relatorios') {
                    setupRelatorios();
                }

                document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                const targetPage = document.getElementById(pageId);
                if (targetPage) {
                    targetPage.classList.add('active');
                    appHeaderTitle.textContent = targetPage.querySelector('.page-title').textContent;
                    document.querySelectorAll('.menu-link').forEach(l => l.classList.remove('active'));
                    const activeLink = document.querySelector(`.menu-link[data-target="${pageId}"]`);
                    if(activeLink) activeLink.classList.add('active');
                }
                sideMenu.classList.remove('active'); overlay.classList.remove('active');
                if (pushState) history.pushState({page: pageId}, `Página ${pageId}`, `#${pageId}`);
            }
            hamburgerMenu?.addEventListener('click', toggleMenu);
            overlay?.addEventListener('click', toggleMenu);
            closeMenuBtn?.addEventListener('click', toggleMenu);
            mainElement.addEventListener('click', (e) => {
                if(e.target.closest('.menu-link')) {
                    e.preventDefault();
                    const targetPageId = e.target.closest('.menu-link').getAttribute('data-target');
                    if (targetPageId) showPage(targetPageId);
                }
            });
             sideMenu.addEventListener('click', (e) => {
                if(e.target.closest('.menu-link')) {
                    e.preventDefault();
                    const targetPageId = e.target.closest('.menu-link').getAttribute('data-target');
                    if (targetPageId) showPage(targetPageId);
                }
            });
            window.onpopstate = function(event) { if(event.state && event.state.page) { showPage(event.state.page, false); } else { showPage('dashboard', false); } };
            
            // --- LÓGICA DA PÁGINA DE DESPESAS (INTACTA) ---
            const formCustoFixo = document.getElementById('form-custo-fixo');
            const listaCustosFixosEl = document.getElementById('lista-custos-fixos');
            const totalCustosFixosEl = document.getElementById('total-custos-fixos');
            const formCustoVariavel = document.getElementById('form-custo-variavel');
            const listaCustosVariaveisEl = document.getElementById('lista-custos-variaveis');
            const totalCustosVariaveisEl = document.getElementById('total-custos-variaveis');
            const custoUnitarioFinalEl = document.getElementById('custo-unitario-final');
            function renderizarCustosFixos() { if(!listaCustosFixosEl) return; listaCustosFixosEl.innerHTML = ''; let total = 0; custosFixos.forEach((custo, index) => { total += custo.valor; const li = document.createElement('li'); li.className = 'cost-item'; li.innerHTML = `<div><span class="cost-name">${custo.nome}</span><span class="cost-details">Vence em: ${formatDate(custo.vencimento)}</span></div><div><span class="cost-value">${formatCurrency(custo.valor)}</span><button class="btn btn-sm btn-danger" data-type="fixo" data-index="${index}"><svg class="icon" style="width:16px; height:16px;"><use href="#icon-trash"/></svg></button></div>`; listaCustosFixosEl.appendChild(li); }); totalCustosFixosEl.textContent = formatCurrency(total); calcularCustoUnitario(); }
            function renderizarCustosVariaveis() { if(!listaCustosVariaveisEl) return; listaCustosVariaveisEl.innerHTML = ''; let totalReais = 0; custosVariaveis.forEach((custo, index) => { if (custo.tipo === 'real') totalReais += custo.valor; const li = document.createElement('li'); li.className = 'cost-item'; const valorFormatado = custo.tipo === 'real' ? formatCurrency(custo.valor) : `${custo.valor}%`; li.innerHTML = `<span class="cost-name">${custo.nome}</span><div><span class="cost-value">${valorFormatado}</span><button class="btn btn-sm btn-danger" data-type="variavel" data-index="${index}"><svg class="icon" style="width:16px; height:16px;"><use href="#icon-trash"/></svg></button></div>`; listaCustosVariaveisEl.appendChild(li); }); totalCustosVariaveisEl.textContent = formatCurrency(totalReais); calcularCustoUnitario(); }
            function calcularCustoUnitario() { if(!custoUnitarioFinalEl) return; const totalFixo = custosFixos.reduce((acc, custo) => acc + custo.valor, 0); const totalVariavelReais = custosVariaveis.filter(c => c.tipo === 'real').reduce((acc, custo) => acc + custo.valor, 0); const totalFrete = parseFloat(document.getElementById('valor-frete')?.value) || 0; const metaVendas = parseInt(document.getElementById('meta-vendas')?.value) || 0; custoUnitarioGlobal = (metaVendas > 0) ? (totalFixo + totalVariavelReais + totalFrete) / metaVendas : 0; custoUnitarioFinalEl.textContent = formatCurrency(custoUnitarioGlobal); }
            formCustoFixo?.addEventListener('submit', function(e) { e.preventDefault(); const nome = this.elements['nome-custo-fixo'].value.trim(), valor = parseFloat(this.elements['valor-custo-fixo'].value), vencimento = this.elements['data-vencimento-fixo'].value; if(nome && !isNaN(valor) && valor > 0 && vencimento) { custosFixos.push({id: Date.now(), nome, valor, vencimento}); renderizarCustosFixos(); this.reset(); this.elements['nome-custo-fixo'].focus(); } });
            formCustoVariavel?.addEventListener('submit', function(e) { e.preventDefault(); const nome = this.elements['nome-custo-variavel'].value.trim(), valor = parseFloat(this.elements['valor-custo-variavel'].value), tipo = this.elements['tipo-custo-variavel'].value; if (nome && !isNaN(valor) && valor > 0) { custosVariaveis.push({nome, valor, tipo}); renderizarCustosVariaveis(); this.reset(); this.elements['nome-custo-variavel'].focus(); } });
            document.querySelectorAll('#despesas .calculator-input').forEach(input => input?.addEventListener('input', calcularCustoUnitario));

            // --- LÓGICA DA PÁGINA DE PRODUTOS (INTACTA) ---
            const btnNovoProduto = document.getElementById('btn-novo-produto'); const formProduto = document.getElementById('form-produto'); const listaProdutosEl = document.getElementById('lista-produtos'); const custoProdutoInput = document.getElementById('custo-produto'); const margemLucroSlider = document.getElementById('margem-lucro'); const variationTypeRadios = document.querySelectorAll('input[name="variation-type"]');
            function openProductModal(produto = null) { formProduto.reset(); document.getElementById('preview-foto').style.display = 'none'; document.getElementById('preview-foto').src = ''; document.getElementById('simple-variation-list').innerHTML = ''; document.getElementById('combined-variation-list').innerHTML = ''; if (produto) { document.getElementById('modal-produto-titulo').textContent = 'Editar Produto'; document.getElementById('produto-id').value = produto.id; document.getElementById('nome-produto').value = produto.nome; document.getElementById('custo-produto').value = produto.custo; document.getElementById('categoria-produto').value = produto.categoria; document.getElementById('margem-lucro').value = produto.margemLucro; if(produto.foto) { document.getElementById('preview-foto').src = produto.foto; document.getElementById('preview-foto').style.display = 'block'; } const variationType = produto.variationType || 'none'; document.querySelector(`input[name="variation-type"][value=${variationType}]`).checked = true; handleVariationTypeChange(); if(variationType === 'none'){ document.getElementById('estoque-produto').value = produto.estoque; } else if (variationType === 'simple'){ document.getElementById('simple-variation-name').value = produto.variationName; produto.variations.forEach(v => addSimpleVariationRow(v.name, v.stock)); } else if (variationType === 'combined'){ document.getElementById('combined-variation-name1').value = produto.attribute1.name; document.getElementById('combined-variation-values1').value = produto.attribute1.values.join(', '); document.getElementById('combined-variation-name2').value = produto.attribute2.name; document.getElementById('combined-variation-values2').value = produto.attribute2.values.join(', '); generateCombinations(produto.variations); } } else { document.getElementById('modal-produto-titulo').textContent = 'Novo Produto'; document.getElementById('produto-id').value = ''; document.querySelector('input[name="variation-type"][value=none]').checked = true; handleVariationTypeChange(); } updatePricing(); openModal('modal-produto'); }
            function updatePricing() { const custoProduto = parseFloat(custoProdutoInput.value) || 0; const margemLucro = parseInt(margemLucroSlider.value) || 0; const custoTotal = custoProduto + custoUnitarioGlobal; const precoSugerido = custoTotal / (1 - (margemLucro / 100)); document.getElementById('custo-unitario-despesa').value = formatCurrency(custoUnitarioGlobal); document.getElementById('custo-total-produto').value = formatCurrency(custoTotal); document.getElementById('margem-lucro-valor').textContent = `${margemLucro}%`; document.getElementById('preco-sugerido').textContent = formatCurrency(precoSugerido); }
            function renderizarProdutos() { if(!listaProdutosEl) return; listaProdutosEl.innerHTML = ''; if(produtos.length === 0) { listaProdutosEl.innerHTML = `<tr><td colspan="4" style="text-align:center; padding: 20px;">Nenhum produto cadastrado.</td></tr>`; return; } produtos.forEach(produto => { const tr = document.createElement('tr'); const totalEstoque = produto.variationType === 'none' ? produto.estoque : produto.variations.reduce((acc, v) => acc + (v.stock || 0), 0); tr.innerHTML = `<td><div class="product-info"><img src="${produto.foto || 'https://placehold.co/100x100/fbcfe8/831843?text=C4'}" alt="Foto de ${produto.nome}" class="product-img"><div><div class="product-name">${produto.nome}</div><div class="product-category">${produto.categoria.charAt(0).toUpperCase() + produto.categoria.slice(1)}</div></div></div></td><td>${formatCurrency(produto.precoSugerido)}</td><td>${totalEstoque} un.${produto.variationType !== 'none' ? `<span class="stock-detail">${produto.variations.length} variações</span>` : ''}</td><td><div class="actions"><button class="btn btn-sm btn-secondary edit-prod-btn" data-id="${produto.id}"><svg class="icon" style="width:16px; height:16px;"><use href="#icon-edit"/></svg></button><button class="btn btn-sm btn-danger delete-prod-btn" data-id="${produto.id}"><svg class="icon" style="width:16px; height:16px;"><use href="#icon-trash"/></svg></button></div></td>`; listaProdutosEl.appendChild(tr); }); updateProductDashboard(); }
            function updateProductDashboard() { const totalAtivosEl = document.getElementById('prod-ativos-total'); const maisEstoqueEl = document.getElementById('prod-mais-estoque'); const maisEstoqueQtdEl = document.getElementById('prod-mais-estoque-qtd'); if (totalAtivosEl) totalAtivosEl.textContent = produtos.length; if (produtos.length > 0) { const sortedByStock = [...produtos].sort((a, b) => { const stockA = a.variationType === 'none' ? a.estoque : a.variations.reduce((acc, v) => acc + v.stock, 0); const stockB = b.variationType === 'none' ? b.estoque : b.variations.reduce((acc, v) => acc + v.stock, 0); return stockB - stockA; }); const produtoMaisEstoque = sortedByStock[0]; const totalEstoque = produtoMaisEstoque.variationType === 'none' ? produtoMaisEstoque.estoque : produtoMaisEstoque.variations.reduce((acc, v) => acc + v.stock, 0); if (maisEstoqueEl) maisEstoqueEl.textContent = produtoMaisEstoque.nome; if (maisEstoqueQtdEl) maisEstoqueQtdEl.textContent = `${totalEstoque} unidades`; } else { if (maisEstoqueEl) maisEstoqueEl.textContent = 'N/A'; if (maisEstoqueQtdEl) maisEstoqueQtdEl.textContent = '0 unidades'; } }
            function handleVariationTypeChange(){ const selectedType = document.querySelector('input[name="variation-type"]:checked').value; document.querySelectorAll('.variation-container').forEach(c => c.classList.remove('active')); document.getElementById(`container-${selectedType === 'none' ? 'no' : selectedType}-variation`).classList.add('active'); }
            variationTypeRadios.forEach(radio => radio.addEventListener('change', handleVariationTypeChange));
            const simpleVariationList = document.getElementById('simple-variation-list'); function addSimpleVariationRow(name = '', stock = '') { const header = document.getElementById('simple-variation-header'); header.style.display = 'grid'; const div = document.createElement('div'); div.className = 'variation-row'; div.innerHTML = `<input type="text" placeholder="Ex: 36" class="simple-variation-row-name" value="${name}" required><input type="number" placeholder="0" class="simple-variation-row-stock" value="${stock}" required><button type="button" class="btn btn-sm btn-danger remove-variation-row">&times;</button>`; simpleVariationList.appendChild(div); }
            document.getElementById('add-simple-variation-btn').addEventListener('click', () => addSimpleVariationRow());
            const combinedVariationList = document.getElementById('combined-variation-list'); function generateCombinations(existingVariations = null){ const name1 = document.getElementById('combined-variation-name1').value.trim() || 'Atributo 1'; const values1 = document.getElementById('combined-variation-values1').value.split(',').map(v => v.trim()).filter(Boolean); const name2 = document.getElementById('combined-variation-name2').value.trim() || 'Atributo 2'; const values2 = document.getElementById('combined-variation-values2').value.split(',').map(v => v.trim()).filter(Boolean); if(!existingVariations && (values1.length === 0 || values2.length === 0)) return; const header = document.getElementById('combined-variation-header'); header.style.display = 'grid'; document.getElementById('header-attr1').textContent = name1; document.getElementById('header-attr2').textContent = name2; combinedVariationList.innerHTML = ''; if (existingVariations) { existingVariations.forEach(v => { addCombinedRow(v.attr1, v.attr2, v.stock); }); } else { values1.forEach(v1 => { values2.forEach(v2 => { addCombinedRow(v1, v2, ''); }); }); } }
            function addCombinedRow(v1, v2, stock) { const div = document.createElement('div'); div.className = 'variation-row combined'; div.innerHTML = `<input type="text" class="combined-variation-row-v1" value="${v1}" readonly><input type="text" class="combined-variation-row-v2" value="${v2}" readonly><input type="number" placeholder="0" class="combined-variation-row-stock" value="${stock}" required><button type="button" class="btn btn-sm btn-danger remove-variation-row">&times;</button>`; combinedVariationList.appendChild(div); }
            document.getElementById('generate-combinations-btn').addEventListener('click', () => generateCombinations()); btnNovoProduto?.addEventListener('click', () => openProductModal()); custoProdutoInput?.addEventListener('input', updatePricing); margemLucroSlider?.addEventListener('input', updatePricing);
            document.getElementById('upload-area')?.addEventListener('click', () => document.getElementById('foto-produto').click()); document.getElementById('foto-produto')?.addEventListener('change', function(e) { if(e.target.files && e.target.files[0]) { const reader = new FileReader(); reader.onload = function(event) { const preview = document.getElementById('preview-foto'); preview.src = event.target.result; preview.style.display = 'block'; }; reader.readAsDataURL(e.target.files[0]); } });
            formProduto?.addEventListener('submit', function(e) { e.preventDefault(); const id = document.getElementById('produto-id').value; const produtoData = { nome: document.getElementById('nome-produto').value, custo: parseFloat(document.getElementById('custo-produto').value), categoria: document.getElementById('categoria-produto').value, margemLucro: parseInt(document.getElementById('margem-lucro').value), precoSugerido: parseCurrency(document.getElementById('preco-sugerido').textContent), foto: document.getElementById('preview-foto').src, variationType: document.querySelector('input[name="variation-type"]:checked').value, variations: [], estoque: 0 }; if (produtoData.variationType === 'none') { produtoData.estoque = parseInt(document.getElementById('estoque-produto').value) || 0; } else if (produtoData.variationType === 'simple') { produtoData.variationName = document.getElementById('simple-variation-name').value; document.querySelectorAll('#simple-variation-list .variation-row').forEach(row => { produtoData.variations.push({ name: row.querySelector('.simple-variation-row-name').value, stock: parseInt(row.querySelector('.simple-variation-row-stock').value) || 0 }); }); } else if (produtoData.variationType === 'combined') { produtoData.attribute1 = { name: document.getElementById('combined-variation-name1').value, values: document.getElementById('combined-variation-values1').value.split(',').map(v => v.trim()) }; produtoData.attribute2 = { name: document.getElementById('combined-variation-name2').value, values: document.getElementById('combined-variation-values2').value.split(',').map(v => v.trim()) }; document.querySelectorAll('#combined-variation-list .variation-row').forEach(row => { produtoData.variations.push({ attr1: row.querySelector('.combined-variation-row-v1').value, attr2: row.querySelector('.combined-variation-row-v2').value, stock: parseInt(row.querySelector('.combined-variation-row-stock').value) || 0 }); }); } if (id) { const index = produtos.findIndex(p => p.id == id); produtos[index] = { ...produtos[index], ...produtoData }; } else { produtoData.id = Date.now(); produtos.push(produtoData); } renderizarProdutos(); closeModal('modal-produto'); });
             
            // --- LÓGICA DA PÁGINA DE VENDAS (INTACTA) ---
            const btnNovaVenda = document.getElementById('btn-nova-venda');
            const formVenda = document.getElementById('form-venda');
            const btnAdicionarItemVenda = document.getElementById('btn-adicionar-item-venda');
            const productSelectionListEl = document.getElementById('product-selection-list');
            const saleItemListEl = document.getElementById('sale-item-list');
            const saleSummaryEl = document.getElementById('sale-summary');
            const saleDiscountValueInput = document.getElementById('sale-discount-value');
            const saleDiscountTypeInput = document.getElementById('sale-discount-type');
            function renderizarVendas() { const listaVendasEl = document.getElementById('lista-vendas'); if(!listaVendasEl) return; listaVendasEl.innerHTML = ''; if(vendas.length === 0) { listaVendasEl.innerHTML = `<tr><td colspan="5" style="text-align:center; padding: 20px;">Nenhuma venda registrada.</td></tr>`; } else { vendas.forEach(venda => { const tr = document.createElement('tr'); tr.innerHTML = `<td>${venda.clienteNome || 'N/A'}</td> <td>${venda.items.length} item(s)</td> <td>${formatCurrency(venda.total)}</td> <td>${formatDate(venda.data)}</td> <td><span class="status-badge pago">Pago</span></td>`; listaVendasEl.appendChild(tr); }); } renderizarDashboardVendas(); renderizarDashboardPrincipal(); }
            function renderizarDashboardVendas() {
                const pedidosMesEl = document.getElementById('vendas-pedidos-mes'); 
                const faturamentoBrutoEl = document.getElementById('vendas-faturamento-bruto'); 
                const lucroLiquidoEl = document.getElementById('vendas-lucro-liquido');
                const itemMaisVendidoEl = document.getElementById('vendas-item-mais-vendido'); 
                
                if(!pedidosMesEl) return; 

                const hoje = new Date();
                const primeiroDiaMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                const ultimoDiaMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);

                const { lucroLiquidoVendas, faturamentoBruto, vendasCount } = getLucroLiquidoPeriodo(primeiroDiaMes, ultimoDiaMes);

                pedidosMesEl.textContent = vendasCount; 
                faturamentoBrutoEl.textContent = formatCurrency(faturamentoBruto); 
                lucroLiquidoEl.textContent = formatCurrency(lucroLiquidoVendas);

                const vendasMes = vendas.filter(v => new Date(v.data) >= primeiroDiaMes && new Date(v.data) <= ultimoDiaMes);
                if (vendasMes.length > 0) { const itemCounts = {}; vendasMes.forEach(venda => { venda.items.forEach(item => { itemCounts[item.nome] = (itemCounts[item.nome] || 0) + item.quantidade; }); }); const maisVendido = Object.keys(itemCounts).sort((a,b) => itemCounts[b] - itemCounts[a])[0]; itemMaisVendidoEl.textContent = maisVendido || 'N/A'; } else { itemMaisVendidoEl.textContent = 'N/A'; } 
            }
            function openVendaModal() { formVenda.reset(); currentSaleItems = []; renderCurrentSaleItems(); updateSaleSummary(); openModal('modal-venda'); }
            function openProductSelectionModal() { productSelectionListEl.innerHTML = ''; produtos.forEach(produto => { const totalEstoque = produto.variationType === 'none' ? produto.estoque : produto.variations.reduce((acc, v) => acc + (v.stock || 0), 0); if (totalEstoque <= 0) return; const itemEl = document.createElement('div'); itemEl.className = 'product-selection-item'; itemEl.dataset.produtoId = produto.id; itemEl.innerHTML = `<div class="product-selection-item-header"><img src="${produto.foto || 'https://placehold.co/100x100/fbcfe8/831843?text=C4'}" alt="${produto.nome}" class="product-img"><div class="product-selection-item-info"><div class="product-name">${produto.nome}</div><div class="product-category">${formatCurrency(produto.precoSugerido)}</div></div></div><div class="product-variation-selection"></div>`; productSelectionListEl.appendChild(itemEl); }); openModal('modal-selecionar-produto'); }
            productSelectionListEl.addEventListener('click', function(e) { const header = e.target.closest('.product-selection-item-header'); if (!header) return; const itemEl = header.parentElement; const wasExpanded = itemEl.classList.contains('expanded'); document.querySelectorAll('.product-selection-item.expanded').forEach(el => el.classList.remove('expanded')); if (wasExpanded) return; itemEl.classList.add('expanded'); const variationContainer = itemEl.querySelector('.product-variation-selection'); const produtoId = itemEl.dataset.produtoId; const produto = produtos.find(p => p.id == produtoId); renderVariationSelector(produto, variationContainer); });
            function renderVariationSelector(produto, container) { container.innerHTML = ''; const addSaleItem = (variation, variationIndex) => { const quantity = parseInt(container.querySelector('.sale-quantity-input').value); if (!quantity || quantity <= 0) { alert('Informe uma quantidade válida.'); return; } if (quantity > variation.stock) { alert('Quantidade indisponível em estoque.'); return; } currentSaleItems.push({ produtoId: produto.id, nome: produto.nome, variation: variation.name ? { name: variation.name, index: variationIndex } : null, quantidade: quantity, precoUnitario: produto.precoSugerido }); renderCurrentSaleItems(); updateSaleSummary(); closeModal('modal-selecionar-produto'); }; const formGroup = document.createElement('div'); formGroup.className = 'form-group'; let variationSelectHtml = ''; if (produto.variationType !== 'none') { const options = produto.variations .map((v, index) => { if (v.stock > 0) { const variationName = v.name || `${v.attr1} / ${v.attr2}`; return `<option value="${index}">${variationName} (Estoque: ${v.stock})</option>`; } return ''; }).join(''); variationSelectHtml = `<label>Selecione a Variação</label><select class="variation-select" required>${options}</select>`; } formGroup.innerHTML = `${variationSelectHtml}<div class="add-item-actions" style="margin-top:10px;"><div><label>Quantidade</label><input type="number" class="sale-quantity-input" value="1" min="1" required></div><button type="button" class="btn btn-primary add-item-to-cart-btn" style="align-self:end;">Adicionar</button></div>`; container.appendChild(formGroup); container.querySelector('.add-item-to-cart-btn').addEventListener('click', () => { let selectedVariation; let selectedIndex = null; if(produto.variationType !== 'none') { selectedIndex = parseInt(container.querySelector('.variation-select').value); selectedVariation = produto.variations[selectedIndex]; } else { selectedVariation = { stock: produto.estoque }; } addSaleItem(selectedVariation, selectedIndex); }); }
            function renderCurrentSaleItems() { if (currentSaleItems.length === 0) { saleItemListEl.innerHTML = `<p style="text-align: center; color: var(--cor-texto-secundario); padding: 10px 0;">Nenhum produto adicionado.</p>`; saleSummaryEl.style.display = 'none'; } else { saleItemListEl.innerHTML = ''; currentSaleItems.forEach((item, index) => { const li = document.createElement('li'); li.className = 'sale-item'; const variationName = item.variation ? `(${item.variation.name})` : ''; li.innerHTML = `<div class="sale-item-info"><div class="sale-item-details"><span class="sale-item-name">${item.nome} ${variationName}</span><span class="sale-item-sub-details">${item.quantidade} x ${formatCurrency(item.precoUnitario)}</span></div><span class="sale-item-total-price">${formatCurrency(item.quantidade * item.precoUnitario)}</span><button type="button" class="btn btn-sm btn-danger remove-sale-item-btn" data-index="${index}">&times;</button></div>`; saleItemListEl.appendChild(li); }); saleSummaryEl.style.display = 'block'; } }
            function updateSaleSummary() { const subtotal = currentSaleItems.reduce((acc, item) => acc + (item.quantidade * item.precoUnitario), 0); const discountValue = parseFloat(saleDiscountValueInput.value) || 0; const discountType = saleDiscountTypeInput.value; let totalDiscount = 0; if(discountType === 'real') { totalDiscount = discountValue; } else { totalDiscount = subtotal * (discountValue / 100); } const total = subtotal - totalDiscount; document.getElementById('sale-subtotal').textContent = formatCurrency(subtotal); document.getElementById('sale-total').textContent = formatCurrency(total < 0 ? 0 : total); }
            saleItemListEl.addEventListener('click', (e) => { if (e.target.closest('.remove-sale-item-btn')) { const index = parseInt(e.target.closest('.remove-sale-item-btn').dataset.index); currentSaleItems.splice(index, 1); renderCurrentSaleItems(); updateSaleSummary(); } });
            btnNovaVenda?.addEventListener('click', openVendaModal);
            btnAdicionarItemVenda?.addEventListener('click', openProductSelectionModal);
            [saleDiscountValueInput, saleDiscountTypeInput].forEach(el => el?.addEventListener('input', updateSaleSummary));

            // --- LÓGICA DO FLUXO DE CAIXA (INTACTA) ---
            const btnNovaSaida = document.getElementById('btn-nova-saida');
            const formSaidaCaixa = document.getElementById('form-saida-caixa');
            const listaTransacoesCaixaEl = document.getElementById('lista-transacoes-caixa');
            
            function verificarCustosFixosVencidos() { const hoje = new Date(); hoje.setHours(0, 0, 0, 0); custosFixos.forEach(custo => { const dataVencimento = new Date(custo.vencimento + 'T00:00:00-03:00'); if (dataVencimento <= hoje) { const ano = dataVencimento.getUTCFullYear(); const mes = dataVencimento.getUTCMonth(); const transacaoId = `custoFixo-${custo.id}-${ano}-${mes}`; const transacaoExiste = fluxoCaixa.some(t => t.origemId === transacaoId); if (!transacaoExiste) { fluxoCaixa.push({ id: Date.now() + Math.random(), data: custo.vencimento, descricao: `Pagamento: ${custo.nome}`, valor: custo.valor, tipo: 'saida', origemId: transacaoId }); } } }); }
            function renderizarFluxoDeCaixa() { if(!listaTransacoesCaixaEl) return; listaTransacoesCaixaEl.innerHTML = ''; fluxoCaixa.sort((a,b) => new Date(b.data) - new Date(a.data)); if(fluxoCaixa.length === 0){ listaTransacoesCaixaEl.innerHTML = `<tr><td colspan="3" style="text-align:center; padding: 20px;">Nenhum lançamento no caixa.</td></tr>`; } else { fluxoCaixa.forEach(transacao => { const tr = document.createElement('tr'); const isEntrada = transacao.tipo === 'entrada'; tr.innerHTML = `<td>${formatDate(transacao.data)}</td><td><svg class="icon transaction-icon" style="color: ${isEntrada ? 'var(--cor-sucesso)' : 'var(--cor-erro)'};"><use href="#icon-arrow-${isEntrada ? 'up' : 'down'}"/></svg>${transacao.descricao}</td><td class="transaction-value ${transacao.tipo}">${formatCurrency(transacao.valor)}</td>`; listaTransacoesCaixaEl.appendChild(tr); }); } renderizarDashboardFluxoCaixa(); }
            function renderizarDashboardFluxoCaixa(){ const totalEntradas = fluxoCaixa.filter(t => t.tipo === 'entrada').reduce((acc, t) => acc + t.valor, 0); const totalSaidas = fluxoCaixa.filter(t => t.tipo === 'saida').reduce((acc, t) => acc + t.valor, 0); const saldoAtual = totalEntradas - totalSaidas; const saldoEl = document.getElementById('caixa-saldo-atual'); const entradasEl = document.getElementById('caixa-total-entradas'); const saidasEl = document.getElementById('caixa-total-saidas'); if(saldoEl) { saldoEl.textContent = formatCurrency(saldoAtual); saldoEl.classList.toggle('positivo', saldoAtual >= 0); saldoEl.classList.toggle('negativo', saldoAtual < 0); } if(entradasEl) entradasEl.textContent = formatCurrency(totalEntradas); if(saidasEl) saidasEl.textContent = formatCurrency(totalSaidas); }
            btnNovaSaida?.addEventListener('click', () => { formSaidaCaixa.reset(); document.getElementById('saida-data').value = new Date().toISOString().split('T')[0]; openModal('modal-saida-caixa'); });
            formSaidaCaixa?.addEventListener('submit', function(e){ e.preventDefault(); const descricao = document.getElementById('saida-descricao').value.trim(); const valor = parseFloat(document.getElementById('saida-valor').value); const data = document.getElementById('saida-data').value; if(!descricao || isNaN(valor) || valor <= 0 || !data) { alert('Por favor, preencha todos os campos corretamente.'); return; } fluxoCaixa.push({ id: Date.now(), data: new Date(data + 'T00:00:00-03:00').toISOString(), descricao, valor, tipo: 'saida' }); renderizarFluxoDeCaixa(); closeModal('modal-saida-caixa'); });
            
            formVenda?.addEventListener('submit', function(e) { e.preventDefault(); if (currentSaleItems.length === 0) { alert('Adicione pelo menos um produto à venda.'); return; } const clienteNome = document.getElementById('venda-cliente-nome').value.trim(); if (!clienteNome) { alert('Informe o nome do cliente.'); return; } currentSaleItems.forEach(item => { const produto = produtos.find(p => p.id === item.produtoId); if (item.variation) { produto.variations[item.variation.index].stock -= item.quantidade; } else { produto.estoque -= item.quantidade; } }); const subtotal = currentSaleItems.reduce((acc, item) => acc + (item.quantidade * item.precoUnitario), 0); const discountValue = parseFloat(saleDiscountValueInput.value) || 0; const discountType = saleDiscountTypeInput.value; let totalDiscount = (discountType === 'real') ? discountValue : subtotal * (discountValue / 100); const totalFinal = subtotal - totalDiscount; const novaVenda = { id: Date.now(), clienteNome: clienteNome, clienteTelefone: document.getElementById('venda-cliente-telefone').value, items: [...currentSaleItems], subtotal: subtotal, desconto: totalDiscount, total: totalFinal, pagamento: document.getElementById('sale-payment').value, data: new Date().toISOString(), status: 'pago' }; vendas.push(novaVenda); fluxoCaixa.push({ id: novaVenda.id, origemId: `venda-${novaVenda.id}`, data: novaVenda.data, descricao: `Venda para ${novaVenda.clienteNome}`, valor: novaVenda.total, tipo: 'entrada' }); renderizarVendas(); renderizarProdutos(); renderizarFluxoDeCaixa(); closeModal('modal-venda'); });
            
            // --- LÓGICA LIBERDADE FINANCEIRA (INTACTA) ---
            const btnAdicionarDivida = document.getElementById('btn-adicionar-divida');
            const formDivida = document.getElementById('form-divida');
            const listaDividasEl = document.getElementById('lista-dividas');
            const planejamentoSelectDivida = document.getElementById('planejamento-selecionar-divida');
            const btnCalcularTempo = document.getElementById('btn-calcular-tempo');
            const btnCriarMeta = document.getElementById('btn-criar-meta');
            function renderizarDividas() { if(!listaDividasEl) return; listaDividasEl.innerHTML = ''; if(dividas.length === 0) { listaDividasEl.innerHTML = `<tr><td colspan="5" style="text-align:center; padding: 20px;">Nenhuma dívida cadastrada. Que ótimo!</td></tr>`; } else { dividas.sort((a,b) => { const prioridades = { alta: 3, media: 2, baixa: 1 }; return prioridades[b.prioridade] - prioridades[a.prioridade];}).forEach(divida => { const valorRestante = divida.valorTotal - divida.valorPago; const progresso = divida.valorTotal > 0 ? (divida.valorPago / divida.valorTotal) * 100 : 0; const tr = document.createElement('tr'); tr.innerHTML = `<td><div>${divida.nome}</div>${divida.temParcelas ? `<div class="product-category">Próx. Venc: ${formatDate(divida.vencimento)} (${divida.parcelasFaltam}x)</div>` : `<div class="product-category">Venc: ${formatDate(divida.vencimento)}</div>`}</td><td>${formatCurrency(valorRestante)}</td><td><div class="progress-bar-container"><div class="progress-bar"><div class="progress" style="width: ${progresso}%;"></div></div><p class="progress-label">${progresso.toFixed(0)}%</p></div></td><td><span class="priority-badge ${divida.prioridade}">${divida.prioridade.charAt(0).toUpperCase() + divida.prioridade.slice(1)}</span></td><td><div class="actions"><button class="btn btn-sm btn-secondary edit-divida-btn" data-id="${divida.id}"><svg class="icon" style="width:16px; height:16px;"><use href="#icon-edit"/></svg></button><button class="btn btn-sm btn-danger delete-divida-btn" data-id="${divida.id}"><svg class="icon" style="width:16px; height:16px;"><use href="#icon-trash"/></svg></button></div></td>`; listaDividasEl.appendChild(tr); }) } renderizarDashboardLiberdadeFinanceira(); }
            function renderizarDashboardLiberdadeFinanceira() {
                const lfTotalDividasEl = document.getElementById('lf-total-dividas');
                if (!lfTotalDividasEl) return;

                const lfProgressoGeralEl = document.getElementById('lf-progresso-geral');
                const lfProgressoGeralLabelEl = document.getElementById('lf-progresso-geral-label');
                const lfMaiorDividaEl = document.getElementById('lf-maior-divida');
                const lfMaiorDividaValorEl = document.getElementById('lf-maior-divida-valor');
                const totalDividas = dividas.reduce((acc, d) => acc + d.valorTotal, 0);
                const totalPago = dividas.reduce((acc, d) => acc + d.valorPago, 0);
                const totalRestante = totalDividas - totalPago;
                const progressoGeral = totalDividas > 0 ? (totalPago / totalDividas) * 100 : 0;
                
                lfTotalDividasEl.textContent = formatCurrency(totalRestante);
                if(lfProgressoGeralEl) lfProgressoGeralEl.style.width = `${progressoGeral}%`;
                if(lfProgressoGeralLabelEl) lfProgressoGeralLabelEl.textContent = `${progressoGeral.toFixed(0)}% quitado`;

                const maiorDivida = [...dividas].sort((a, b) => (b.valorTotal - b.valorPago) - (a.valorTotal - a.valorPago))[0];
                if(maiorDivida) {
                    if(lfMaiorDividaEl) lfMaiorDividaEl.textContent = maiorDivida.nome;
                    if(lfMaiorDividaValorEl) lfMaiorDividaValorEl.textContent = formatCurrency(maiorDivida.valorTotal - maiorDivida.valorPago);
                } else {
                     if(lfMaiorDividaEl) lfMaiorDividaEl.textContent = "N/A";
                     if(lfMaiorDividaValorEl) lfMaiorDividaValorEl.textContent = "";
                }
                renderizarDashboardPrincipal();
            }
            function openDividaModal(divida = null) {
                formDivida.reset();
                document.getElementById('container-parcelas').style.display = 'none';
                if(divida) {
                    document.getElementById('modal-divida-titulo').textContent = 'Editar Dívida';
                    document.getElementById('divida-id').value = divida.id;
                    document.getElementById('divida-nome').value = divida.nome;
                    document.getElementById('divida-valor-total').value = divida.valorTotal;
                    document.getElementById('divida-valor-pago').value = divida.valorPago;
                    document.getElementById('divida-prioridade').value = divida.prioridade;
                    document.getElementById('divida-vencimento').value = divida.vencimento;
                    const temParcelasRadio = document.querySelector(`input[name="divida-tem-parcelas"][value="${divida.temParcelas ? 'sim' : 'nao'}"]`);
                    if(temParcelasRadio) temParcelasRadio.checked = true;
                    if(divida.temParcelas){
                        document.getElementById('container-parcelas').style.display = 'block';
                        document.getElementById('divida-parcelas-faltam').value = divida.parcelasFaltam;
                    }
                } else {
                    document.getElementById('modal-divida-titulo').textContent = 'Adicionar Nova Dívida';
                    document.getElementById('divida-id').value = '';
                }
                openModal('modal-divida');
            }
            function popularDropdownDividas() { if(!planejamentoSelectDivida) return; planejamentoSelectDivida.innerHTML = '<option value="">-- Selecione uma dívida --</option>'; dividas.forEach(d => { const option = new Option(`${d.nome} (${formatCurrency(d.valorTotal - d.valorPago)})`, d.id); planejamentoSelectDivida.add(option); }); }
            function atualizarPlanejamentoQuitacao(dividaId) { const container = document.getElementById('planejamento-container'); if(!dividaId) { container.style.display = 'none'; return; } const divida = dividas.find(d => d.id == dividaId); if(!divida) return; container.style.display = 'grid'; document.getElementById('plan-divida-nome').textContent = divida.nome; document.getElementById('plan-divida-valor-total').textContent = formatCurrency(divida.valorTotal); document.getElementById('plan-valor-ja-pago').value = divida.valorPago; document.getElementById('meta-tempo-resultado').style.display = 'none'; atualizarMetaQuitacao(divida); }
            function atualizarMetaQuitacao(divida) { const valorJaPago = parseFloat(document.getElementById('plan-valor-ja-pago').value) || 0; const valorTotal = divida.valorTotal; const valorRestante = valorTotal - valorJaPago; const progresso = valorTotal > 0 ? (valorJaPago / valorTotal) * 100 : 0; document.getElementById('meta-divida-nome').textContent = divida.nome; document.getElementById('meta-progresso-barra').style.width = `${progresso}%`; document.getElementById('meta-valor-total').textContent = formatCurrency(valorTotal); document.getElementById('meta-valor-pago').textContent = formatCurrency(valorJaPago); document.getElementById('meta-valor-restante').textContent = formatCurrency(valorRestante); }
            function calcularTempoEstimado() { const dividaId = planejamentoSelectDivida.value; if(!dividaId) return; const divida = dividas.find(d => d.id == dividaId); const valorPoupanca = parseFloat(document.getElementById('plan-poupanca-valor').value) || 0; const freqPoupanca = document.getElementById('plan-poupanca-freq').value; const valorJaPago = parseFloat(document.getElementById('plan-valor-ja-pago').value) || 0; const valorRestante = divida.valorTotal - valorJaPago; const resultadoEl = document.getElementById('meta-tempo-resultado'); if (valorPoupanca <= 0 || valorRestante <= 0) { resultadoEl.style.display = 'none'; return; } let poupancaDiaria; switch (freqPoupanca) { case 'semana': poupancaDiaria = valorPoupanca / 7; break; case 'quinzena': poupancaDiaria = valorPoupanca / 15; break; case 'mes': poupancaDiaria = valorPoupanca / 30; break; default: poupancaDiaria = valorPoupanca; } const diasParaQuitar = Math.ceil(valorRestante / poupancaDiaria); const anos = Math.floor(diasParaQuitar / 365); const meses = Math.floor((diasParaQuitar % 365) / 30); const dias = (diasParaQuitar % 365) % 30; let tempoEstimado = ''; if(anos > 0) tempoEstimado += `${anos} ano(s) `; if(meses > 0) tempoEstimado += `${meses} mes(es) `; if(dias > 0 && anos === 0) tempoEstimado += `${dias} dia(s)`; tempoEstimado = tempoEstimado.trim(); document.getElementById('meta-tempo-estimado').textContent = tempoEstimado || "Menos de 1 dia"; resultadoEl.style.display = 'block'; const produtoExemplo = produtos[0]; if(produtoExemplo) { const lucroProduto = produtoExemplo.precoSugerido - produtoExemplo.custo; const unidadesNecessarias = Math.ceil(valorRestante / lucroProduto); document.getElementById('ideias-acelerar-texto').innerHTML = `► Vender <strong>${unidadesNecessarias} unidades</strong> do Produto "${produtoExemplo.nome}" (Lucro Estimado: ${formatCurrency(lucroProduto)}/un)`; } }
            
            btnAdicionarDivida?.addEventListener('click', () => openDividaModal());
            document.querySelectorAll('input[name="divida-tem-parcelas"]').forEach(radio => { radio.addEventListener('change', function() { document.getElementById('container-parcelas').style.display = this.value === 'sim' ? 'block' : 'none'; }); });
            formDivida?.addEventListener('submit', function(e){ e.preventDefault(); const id = document.getElementById('divida-id').value; const temParcelas = document.querySelector('input[name="divida-tem-parcelas"]:checked').value === 'sim'; const dadosDivida = { nome: document.getElementById('divida-nome').value.trim(), valorTotal: parseFloat(document.getElementById('divida-valor-total').value), valorPago: parseFloat(document.getElementById('divida-valor-pago').value), prioridade: document.getElementById('divida-prioridade').value, vencimento: document.getElementById('divida-vencimento').value, temParcelas: temParcelas, parcelasFaltam: temParcelas ? parseInt(document.getElementById('divida-parcelas-faltam').value) : 0 }; if (!dadosDivida.nome || isNaN(dadosDivida.valorTotal) || isNaN(dadosDivida.valorPago) || !dadosDivida.vencimento) { alert("Por favor, preencha todos os campos obrigatórios."); return; } if(id){ const index = dividas.findIndex(d => d.id == id); dividas[index] = { ...dividas[index], ...dadosDivida }; } else { dadosDivida.id = Date.now(); dividas.push(dadosDivida); } renderizarDividas(); popularDropdownDividas(); closeModal('modal-divida'); });
            planejamentoSelectDivida?.addEventListener('change', (e) => atualizarPlanejamentoQuitacao(e.target.value));
            document.getElementById('plan-valor-ja-pago')?.addEventListener('input', () => atualizarPlanejamentoQuitacao(planejamentoSelectDivida.value));
            btnCalcularTempo?.addEventListener('click', calcularTempoEstimado);
            btnCriarMeta?.addEventListener('click', function() {
                const valorPoupanca = parseFloat(document.getElementById('plan-poupanca-valor').value) || 0;
                const freqPoupanca = document.getElementById('plan-poupanca-freq').value;
                if (valorPoupanca <= 0) { alert('Por favor, insira um valor de poupança válido.'); return; }
                let poupancaDiaria;
                switch (freqPoupanca) { case 'semana': poupancaDiaria = valorPoupanca / 7; break; case 'quinzena': poupancaDiaria = valorPoupanca / 15; break; case 'mes': poupancaDiaria = valorPoupanca / 30; break; default: poupancaDiaria = valorPoupanca; }
                planoQuitacaoAtivo = { poupancaDiaria: poupancaDiaria.toFixed(2), poupancaMensal: (poupancaDiaria * 30).toFixed(2), dividaNome: document.getElementById('meta-divida-nome').textContent };
                metaDiariaConcluida.data = null; 
                localStorage.setItem('planoQuitacaoAtivo', JSON.stringify(planoQuitacaoAtivo));
                localStorage.setItem('metaDiariaConcluida', JSON.stringify(metaDiariaConcluida));
                alert('Meta criada com sucesso! Você verá seu progresso no Dashboard.');
                renderizarCardMetaDividas();
                showPage('dashboard');
            });
            
            function renderizarCardMetaDividas() {
                const container = document.getElementById('meta-divida-conteudo');
                if (!container) return;

                if (Object.keys(planoQuitacaoAtivo).length > 0) {
                    const hoje = getTodayString();
                    const metaConcluidaHoje = metaDiariaConcluida.data === hoje;

                    container.innerHTML = `
                        <p class="detail" style="text-align:center; font-size:1rem; margin-bottom:10px;">
                            Meta para quitar: <strong>${planoQuitacaoAtivo.dividaNome}</strong>
                        </p>
                        <p class="card-content" style="font-size:1.5rem; text-align:center;">${formatCurrency(planoQuitacaoAtivo.poupancaDiaria)} <span style="font-size:1rem; font-weight:400;">/ dia</span></p>
                        <p class="detail" style="text-align:center;">Total no mês: ${formatCurrency(planoQuitacaoAtivo.poupancaMensal)}</p>
                        <div class="checkbox-group" style="margin-top:15px;">
                            <input type="checkbox" id="check-meta-diaria" ${metaConcluidaHoje ? 'checked' : ''}>
                            <label for="check-meta-diaria">${metaConcluidaHoje ? 'Meta de hoje concluída!' : 'Já guardei o de hoje!'}</label>
                        </div>
                    `;

                    container.querySelector('#check-meta-diaria').addEventListener('change', function() {
                        if (this.checked) {
                            metaDiariaConcluida.data = hoje;
                            localStorage.setItem('metaDiariaConcluida', JSON.stringify(metaDiariaConcluida));
                            this.parentElement.querySelector('label').textContent = 'Meta de hoje concluída!';
                            mostrarNotificacao('Parabéns por manter o foco na sua meta!', 'sucesso', 3000);
                        } else {
                             metaDiariaConcluida.data = null;
                             localStorage.setItem('metaDiariaConcluida', JSON.stringify(metaDiariaConcluida));
                             this.parentElement.querySelector('label').textContent = 'Já guardei o de hoje!';
                        }
                    });

                } else {
                    container.innerHTML = `
                        <p class="detail" style="text-align:center;">Nenhuma meta de quitação ativa.</p>
                        <button class="btn btn-secondary menu-link" style="width:100%; margin-top:15px;" data-target="liberdade-financeira">Criar um Plano</button>
                    `;
                }
            }
            
            function mostrarNotificacao(mensagem, tipo = 'info', duracao = 5000) {
                const notification = document.getElementById('app-notification');
                const textEl = document.getElementById('notification-text');
                
                notification.className = 'app-notification'; // Reset
                if (tipo === 'sucesso') {
                    notification.style.backgroundColor = 'var(--cor-sucesso)';
                    notification.style.color = 'var(--cor-texto-claro)';
                } else {
                    notification.style.backgroundColor = 'var(--cor-secundaria)';
                    notification.style.color = 'var(--cor-texto)';
                }
                
                textEl.textContent = mensagem;
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, duracao);
            }

             document.getElementById('notification-close').addEventListener('click', () => {
                document.getElementById('app-notification').classList.remove('show');
            });


             // --- GESTÃO DE EVENTOS GLOBAIS ---
             mainElement.addEventListener('click', function(e) { 
                const removeVarBtn = e.target.closest('.remove-variation-row'); if(removeVarBtn) { const list = removeVarBtn.parentElement.parentElement; removeVarBtn.parentElement.remove(); if(list.children.length === 0){ const header = list.previousElementSibling; if(header && header.classList.contains('variation-header')) header.style.display = 'none'; } }
                const editProdBtn = e.target.closest('.edit-prod-btn'); if (editProdBtn) { const produto = produtos.find(p => p.id == editProdBtn.dataset.id); openProductModal(produto); }
                const deleteProdBtn = e.target.closest('.delete-prod-btn'); if (deleteProdBtn) { const produtoId = deleteProdBtn.dataset.id; if(confirm('Tem certeza que deseja excluir este produto?')) { produtos = produtos.filter(p => p.id != produtoId); renderizarProdutos(); } }
                const costDeleteBtn = e.target.closest('.costs-list button.btn-danger'); if (costDeleteBtn) { const type = costDeleteBtn.dataset.type; const index = parseInt(costDeleteBtn.dataset.index); if (type === 'fixo') { custosFixos.splice(index, 1); renderizarCustosFixos(); } else if (type === 'variavel') { custosVariaveis.splice(index, 1); renderizarCustosVariaveis(); } }
                const editDividaBtn = e.target.closest('.edit-divida-btn'); if(editDividaBtn){ const divida = dividas.find(d => d.id == editDividaBtn.dataset.id); openDividaModal(divida); }
                const deleteDividaBtn = e.target.closest('.delete-divida-btn'); if(deleteDividaBtn){ if(confirm('Tem certeza que deseja excluir esta dívida?')){ const dividaId = deleteDividaBtn.dataset.id; dividas = dividas.filter(d => d.id != dividaId); renderizarDividas(); } }
            });

            // --- LÓGICA DAS CALCULADORAS (ATUALIZADO) ---
            function calcularLucroCerto(){
                const custo = parseFloat(document.getElementById('calc-lc-custo')?.value) || 0;
                const despesas = parseFloat(document.getElementById('calc-lc-despesas')?.value) || 0;
                const margem = parseFloat(document.getElementById('calc-lc-margem')?.value) || 0;
                const margemValorEl = document.getElementById('calc-lc-margem-valor');
                if (margemValorEl) margemValorEl.textContent = `${margem}%`;

                const custoTotal = custo + despesas;
                
                let precoVenda = 0;
                if (margem < 100) {
                    precoVenda = custoTotal / (1 - (margem / 100));
                }
                
                const lucroBruto = precoVenda > 0 ? precoVenda - custoTotal : 0;

                document.getElementById('calc-lc-preco-venda').textContent = formatCurrency(precoVenda);
                document.getElementById('calc-lc-lucro-bruto').textContent = formatCurrency(lucroBruto);
            }

            function calcularPromocao(){
                const select = document.getElementById('calc-promo-produto');
                const produtoId = select?.value;
                const produto = produtos.find(p => p.id == produtoId);
                const precoAtual = produto ? produto.precoSugerido : 0;
                const custo = produto ? produto.custo : 0;
                
                document.getElementById('calc-promo-preco-atual').value = formatCurrency(precoAtual);
                document.getElementById('calc-promo-custo').value = formatCurrency(custo);

                const desconto = parseFloat(document.getElementById('calc-promo-desconto')?.value) || 0;
                const novoPreco = precoAtual * (1 - (desconto / 100));
                const novoLucro = novoPreco - custo;
                const novaMargem = novoPreco > 0 ? (novoLucro / novoPreco) * 100 : 0;

                document.getElementById('calc-promo-novo-preco').textContent = formatCurrency(novoPreco);
                document.getElementById('calc-promo-novo-lucro').textContent = formatCurrency(novoLucro);
                document.getElementById('calc-promo-nova-margem').textContent = `${novaMargem.toFixed(0)}%`;
            }
            
            function calcularFreteGratis(){
                const custoFrete = parseFloat(document.getElementById('calc-frete-custo')?.value) || 0;
                const margemLucro = parseFloat(document.getElementById('calc-frete-margem')?.value) || 0;
                if (margemLucro <= 0) {
                    document.getElementById('calc-frete-resultado').textContent = 'Inválido';
                    return;
                }
                const valorMinimo = custoFrete / (margemLucro / 100);
                document.getElementById('calc-frete-resultado').textContent = formatCurrency(valorMinimo);
            }

            function calcularDistribuicaoLucro() {
                const lucroLiquidoInput = document.getElementById('calc-reinvest-lucro');
                const pieChart = document.getElementById('reinvest-pie-chart');
                const legend = document.getElementById('reinvest-legend');
                
                if(!lucroLiquidoInput || !pieChart || !legend) return;

                const lucroLiquido = parseFloat(lucroLiquidoInput.value) || 0;
                const distribuicao = {
                    reinvestimento: parseFloat(document.getElementById('perc-reinvestimento')?.value),
                    dividas: parseFloat(document.getElementById('perc-dividas')?.value),
                    reserva: parseFloat(document.getElementById('perc-reserva')?.value),
                    pessoal: parseFloat(document.getElementById('perc-pessoal')?.value),
                };

                let gradient = 'conic-gradient(';
                let currentAngle = 0;
                const cores = { reinvestimento: '#2dd4bf', dividas: '#f8b81f', reserva: '#60a5fa', pessoal: '#a78bfa' };
                legend.innerHTML = '';
                
                let totalPerc = Object.values(distribuicao).reduce((sum, val) => sum + val, 0);

                for (const [key, perc] of Object.entries(distribuicao)) {
                    const valor = lucroLiquido * (perc / 100);
                    const angulo = totalPerc > 0 ? (perc / totalPerc) * 360 : 0;
                    const endAngle = currentAngle + angulo;
                    if(perc > 0) {
                        gradient += `${cores[key]} ${currentAngle}deg ${endAngle}deg, `;
                    }
                    const li = document.createElement('li');
                    li.className = 'legend-item';
                    const keyName = key.charAt(0).toUpperCase() + key.slice(1);
                    li.innerHTML = `<span class="legend-color" style="background-color: ${cores[key]}"></span>${keyName}: <strong style="margin-left:auto; color:var(--cor-texto)">${formatCurrency(valor)}</strong>`;
                    legend.appendChild(li);
                    currentAngle = endAngle;
                }
                gradient = gradient.length > 15 ? gradient.slice(0, -2) + ')' : '#f1f5f9';
                pieChart.style.background = gradient;
            }

            function getLucroLiquidoPeriodo(startDate, endDate) {
                const vendasPeriodo = vendas.filter(v => {
                    const dataVenda = new Date(v.data);
                    return dataVenda >= startDate && dataVenda <= endDate;
                });

                const faturamentoBruto = vendasPeriodo.reduce((acc, v) => acc + v.total, 0);
                
                const custoProdutosVendidos = vendasPeriodo.reduce((acc, v) => {
                    return acc + v.items.reduce((itemAcc, item) => {
                        const produto = produtos.find(p => p.id === item.produtoId);
                        return itemAcc + (produto ? produto.custo * item.quantidade : 0);
                    }, 0);
                }, 0);
                
                const despesasPeriodo = fluxoCaixa.filter(t => t.tipo === 'saida' && new Date(t.data) >= startDate && new Date(t.data) <= endDate);
                const totalDespesas = despesasPeriodo.reduce((acc, d) => acc + d.valor, 0);
                
                const lucroLiquidoDashboard = faturamentoBruto - custoProdutosVendidos - totalDespesas;
                
                // Este é o lucro apenas das vendas, sem outras despesas.
                const lucroLiquidoVendas = faturamentoBruto - custoProdutosVendidos;

                return { lucroLiquidoDashboard, lucroLiquidoVendas, faturamentoBruto, vendasCount: vendasPeriodo.length };
            }

            function setupCalculadoras() {
                // Preenche campos automáticos
                document.getElementById('calc-lc-despesas').value = custoUnitarioGlobal.toFixed(2);
                const hoje = new Date();
                const primeiroDiaMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                const ultimoDiaMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
                const { lucroLiquidoDashboard } = getLucroLiquidoPeriodo(primeiroDiaMes, ultimoDiaMes);
                document.getElementById('calc-reinvest-lucro').value = lucroLiquidoDashboard > 0 ? lucroLiquidoDashboard.toFixed(2) : '0.00';

                const selectPromo = document.getElementById('calc-promo-produto');
                selectPromo.innerHTML = '<option value="">Selecione um produto...</option>';
                produtos.forEach(p => {
                    const option = new Option(p.nome, p.id);
                    selectPromo.add(option);
                });
                
                document.querySelectorAll('#calculadoras .calculator-input').forEach(input => {
                    input.addEventListener('input', () => {
                        const card = input.closest('.card');
                        if (card.contains(document.getElementById('calc-lc-custo'))) calcularLucroCerto();
                        if (card.contains(document.getElementById('calc-promo-produto'))) calcularPromocao();
                        if (card.contains(document.getElementById('calc-frete-custo'))) calcularFreteGratis();
                    });
                });
                
                document.querySelectorAll('.dist-slider').forEach(slider => {
                     slider.addEventListener('input', function() {
                        this.nextElementSibling.textContent = `${this.value}%`;
                        calcularDistribuicaoLucro();
                    });
                });
                
                document.getElementById('calc-lc-margem')?.addEventListener('input', function() {
                    document.getElementById('calc-lc-margem-valor').textContent = `${this.value}%`;
                    calcularLucroCerto();
                });

                // Inicializa os cálculos
                calcularLucroCerto();
                calcularPromocao();
                calcularFreteGratis();
                calcularDistribuicaoLucro();
            }

            // --- LÓGICA DE RELATÓRIOS (NOVO) ---
            const btnGerarRelatorio = document.getElementById('btn-gerar-relatorio');
            const relatorioDataInicioEl = document.getElementById('relatorio-data-inicio');
            const relatorioDataFimEl = document.getElementById('relatorio-data-fim');

            function setupRelatorios() {
                const hoje = new Date();
                const primeiroDiaMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1).toISOString().split('T')[0];
                const ultimoDiaMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0).toISOString().split('T')[0];
                relatorioDataInicioEl.value = primeiroDiaMes;
                relatorioDataFimEl.value = ultimoDiaMes;
                gerarRelatorios();
            }

            function gerarRelatorios() {
                const dataInicio = new Date(relatorioDataInicioEl.value + 'T00:00:00-03:00');
                const dataFim = new Date(relatorioDataFimEl.value + 'T23:59:59-03:00');
                const vendasFiltradas = vendas.filter(v => new Date(v.data) >= dataInicio && new Date(v.data) <= dataFim);
                const despesasFiltradas = fluxoCaixa.filter(t => t.tipo === 'saida' && new Date(t.data) >= dataInicio && new Date(t.data) <= dataFim);

                const faturamentoBruto = vendasFiltradas.reduce((acc, v) => acc + v.total, 0);
                const totalDespesas = despesasFiltradas.reduce((acc, d) => acc + d.valor, 0);
                const lucroLiquido = getLucroLiquidoPeriodo(dataInicio, dataFim).lucroLiquidoDashboard;
                
                document.getElementById('relatorio-faturamento').textContent = formatCurrency(faturamentoBruto);
                document.getElementById('relatorio-lucro').textContent = formatCurrency(lucroLiquido);
                document.getElementById('relatorio-despesas').textContent = formatCurrency(totalDespesas);
                document.getElementById('relatorio-num-vendas').textContent = vendasFiltradas.length;

                renderizarTabelaRelatorio('relatorio-vendas-table', vendasFiltradas, ['data', 'clienteNome', 'total']);
                renderizarTabelaRelatorio('relatorio-despesas-table', despesasFiltradas, ['data', 'descricao', 'valor']);
                renderizarTabelaProdutosRentaveis(vendasFiltradas);
                
                document.getElementById('relatorio-container').style.display = 'block';
            }

            function renderizarTabelaRelatorio(tableId, dados, colunas) {
                const tabelaBody = document.getElementById(tableId);
                if(!tabelaBody) return;
                tabelaBody.innerHTML = '';
                if(dados.length === 0){
                    tabelaBody.innerHTML = `<tr><td colspan="${colunas.length}" style="text-align:center; padding: 20px;">Nenhum dado encontrado para o período.</td></tr>`;
                    return;
                }
                dados.forEach(item => {
                    const tr = document.createElement('tr');
                    colunas.forEach(coluna => {
                        const td = document.createElement('td');
                        let valor = item[coluna];
                        if(coluna === 'data') valor = formatDate(valor);
                        if(['total', 'valor'].includes(coluna)) valor = formatCurrency(valor);
                        td.textContent = valor;
                        tr.appendChild(td);
                    });
                    tabelaBody.appendChild(tr);
                });
            }

            function renderizarTabelaProdutosRentaveis(vendasFiltradas) {
                 const tabelaBody = document.getElementById('relatorio-produtos-rentaveis-table');
                 if(!tabelaBody) return;
                 
                 const lucrosPorProduto = {};

                 vendasFiltradas.forEach(venda => {
                     venda.items.forEach(item => {
                         const produto = produtos.find(p => p.id === item.produtoId);
                         if(produto){
                             const lucroItem = (item.precoUnitario - produto.custo) * item.quantidade;
                             if(!lucrosPorProduto[produto.id]) {
                                 lucrosPorProduto[produto.id] = { nome: produto.nome, quantidade: 0, lucroTotal: 0 };
                             }
                             lucrosPorProduto[produto.id].quantidade += item.quantidade;
                             lucrosPorProduto[produto.id].lucroTotal += lucroItem;
                         }
                     });
                 });
                 
                 const produtosRankeados = Object.values(lucrosPorProduto).sort((a,b) => b.lucroTotal - a.lucroTotal);
                 
                 tabelaBody.innerHTML = '';
                 if(produtosRankeados.length === 0){
                    tabelaBody.innerHTML = `<tr><td colspan="3" style="text-align:center; padding: 20px;">Nenhuma venda encontrada para o período.</td></tr>`;
                    return;
                }
                 produtosRankeados.forEach(p => {
                     const tr = document.createElement('tr');
                     tr.innerHTML = `
                        <td>${p.nome}</td>
                        <td>${p.quantidade} un.</td>
                        <td>${formatCurrency(p.lucroTotal)}</td>
                     `;
                     tabelaBody.appendChild(tr);
                 });
            }
            
            btnGerarRelatorio?.addEventListener('click', gerarRelatorios);
            document.querySelectorAll('#relatorios .btn-secondary').forEach(btn => btn.addEventListener('click', () => alert('Funcionalidade de exportação em desenvolvimento.')));

            // --- FUNÇÃO DE RENDERIZAÇÃO DO DASHBOARD PRINCIPAL (NOVA) ---
            function renderizarDashboardPrincipal() {
                const faturamentoEl = document.getElementById('dashboard-faturamento');
                if(!faturamentoEl) return; // Se não está na página do dashboard, não faz nada
                
                const lucroEl = document.getElementById('dashboard-lucro');
                const pedidosEl = document.getElementById('dashboard-pedidos');
                const pieChartEl = document.getElementById('vendas-pie-chart');
                const legendEl = document.getElementById('vendas-legend');
                
                const hoje = new Date();
                const primeiroDiaMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                const ultimoDiaMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
                
                const { lucroLiquidoDashboard, faturamentoBruto, vendasCount } = getLucroLiquidoPeriodo(primeiroDiaMes, ultimoDiaMes);
                
                faturamentoEl.textContent = formatCurrency(faturamentoBruto);
                lucroEl.textContent = formatCurrency(lucroLiquidoDashboard);
                pedidosEl.textContent = vendasCount;

                // Renderizar o gráfico de pizza
                const vendasMes = vendas.filter(v => new Date(v.data) >= primeiroDiaMes && new Date(v.data) <= ultimoDiaMes);
                const vendasPorCategoria = vendasMes.reduce((acc, venda) => {
                    venda.items.forEach(item => {
                        const produto = produtos.find(p => p.id === item.produtoId);
                        if(produto){
                            acc[produto.categoria] = (acc[produto.categoria] || 0) + item.precoUnitario * item.quantidade;
                        }
                    });
                    return acc;
                }, {});

                const totalVendas = Object.values(vendasPorCategoria).reduce((sum, v) => sum + v, 0);
                let gradient = 'conic-gradient(';
                let currentAngle = 0;
                const cores = { bolsa: '#2dd4bf', calcado: '#f8b81f', perfumaria: '#f472b6', maquiagem: '#a78bfa', skincare: '#60a5fa', acessorio: '#ec4899', default: '#a8a29e' };
                legendEl.innerHTML = '';
                
                Object.entries(vendasPorCategoria).forEach(([categoria, valor]) => {
                    const percent = totalVendas > 0 ? (valor / totalVendas) * 100 : 0;
                    const endAngle = currentAngle + (percent * 3.6);
                    const cor = cores[categoria] || cores.default;
                    if(percent > 0) {
                        gradient += `${cor} ${currentAngle}deg ${endAngle}deg, `;
                        const li = document.createElement('li');
                        li.className = 'legend-item';
                        li.innerHTML = `<span class="legend-color" style="background-color: ${cor}"></span>${categoria.charAt(0).toUpperCase() + categoria.slice(1)}`;
                        legendEl.appendChild(li);
                    }
                    currentAngle = endAngle;
                });
                 gradient = gradient.length > 15 ? gradient.slice(0, -2) + ')' : '#f1f5f9';
                pieChartEl.style.background = gradient;
            }

            // --- INICIALIZAÇÃO DA APLICAÇÃO ---
            function init() {
                const hoje = new Date(); 
                const ano = hoje.getFullYear();
                const mes = String(hoje.getMonth() + 1).padStart(2, '0');
                
                planoQuitacaoAtivo = JSON.parse(localStorage.getItem('planoQuitacaoAtivo')) || {};
                metaDiariaConcluida = JSON.parse(localStorage.getItem('metaDiariaConcluida')) || { data: null };
                
                custosFixos = [ { id: 1, nome: 'Aluguel do Ateliê', valor: 850, vencimento: `${ano}-${mes}-10` }, { id: 2, nome: 'Plano de Internet', valor: 99.90, vencimento: `${ano}-${mes}-15` }, { id: 3, nome: 'Pró-labore', valor: 1500, vencimento: `${ano}-${mes}-05` }];
                custosVariaveis = [ { nome: 'Comissão Vendedora', valor: 10, tipo: 'percent' }, { nome: 'Taxa Maquininha Crédito', valor: 4.99, tipo: 'percent' }, { nome: 'Embalagens (por venda)', valor: 2.50, tipo: 'real' }];
                produtos = [
                    { id: 1, nome: 'Bolsa Couro Luxo', custo: 80, categoria: 'bolsa', margemLucro: 120, precoSugerido: 176, foto: 'https://placehold.co/100x100/db1472/ffffff?text=Bolsa', variationType: 'none', estoque: 25, variations: [] },
                    { id: 2, nome: 'Rasteirinha Átria', custo: 35, categoria: 'calcado', margemLucro: 100, precoSugerido: 70, foto: 'https://placehold.co/100x100/f8b81f/ffffff?text=Rasteirinha', variationType: 'combined', attribute1: {name: 'Cor', values:['Preto', 'Nude']}, attribute2: {name: 'Tamanho', values:['35','36']}, variations: [{attr1: 'Preto', attr2: '35', stock: 10},{attr1: 'Preto', attr2: '36', stock: 10},{attr1: 'Nude', attr2: '35', stock: 5},{attr1: 'Nude', attr2: '36', stock: 8}]},
                    { id: 3, nome: 'Perfume Floral', custo: 60, categoria: 'perfumaria', margemLucro: 150, precoSugerido: 150, foto: 'https://placehold.co/100x100/10b981/ffffff?text=Perfume', variationType: 'simple', variationName: 'Volume', variations: [{name: '50ml', stock: 20}, {name: '100ml', stock: 15}] },
                ];
                vendas = [
                    {id: 1, clienteNome: 'Ana Silva', items: [{produtoId: 1, nome: 'Bolsa Couro Luxo', variation: null, quantidade: 1, precoUnitario: 176}], subtotal: 176, desconto: 10, total: 166, pagamento: 'pix', data: new Date(`${ano}-${mes}-10T10:00:00Z`).toISOString(), status: 'pago' },
                    {id: 2, clienteNome: 'Beatriz Costa', items: [{produtoId: 2, nome: 'Rasteirinha Átria', variation: { name: 'Preto / 36', index: 1}, quantidade: 1, precoUnitario: 70}], subtotal: 70, desconto: 0, total: 70, pagamento: 'credito', data: new Date(`${ano}-${mes}-11T15:30:00Z`).toISOString(), status: 'pago' }
                ];
                dividas = [
                    { id: 1, nome: 'Cartão de Crédito', valorTotal: 4500, valorPago: 1200, prioridade: 'alta', vencimento: `${ano}-${mes}-28`, temParcelas: true, parcelasFaltam: 8 },
                    { id: 2, nome: 'Empréstimo Fornecedor', valorTotal: 2000, valorPago: 1500, prioridade: 'media', vencimento: `${ano}-${mes}-20`, temParcelas: false, parcelasFaltam: 0 },
                    { id: 3, nome: 'Financiamento Máquina', valorTotal: 8000, valorPago: 2000, prioridade: 'baixa', vencimento: `${ano}-${mes}-15`, temParcelas: true, parcelasFaltam: 12 }
                ];

                vendas.forEach(v => fluxoCaixa.push({id: v.id, origemId: `venda-${v.id}`, data: v.data, descricao: `Venda para ${v.clienteNome}`, valor: v.total, tipo: 'entrada'}));
                fluxoCaixa.push({id: 99, data: new Date(`${ano}-${mes}-01T10:00:00Z`).toISOString(), descricao: 'Compra de matéria-prima', valor: 450, tipo: 'saida'});
                
                verificarCustosFixosVencidos();
                
                renderizarCustosFixos(); renderizarCustosVariaveis(); renderizarProdutos(); renderizarVendas(); renderizarFluxoDeCaixa(); renderizarDividas();
                popularDropdownDividas();
                renderizarCardMetaDividas();
                
                if(Object.keys(planoQuitacaoAtivo).length > 0 && metaDiariaConcluida.data !== getTodayString()){
                    setTimeout(() => {
                        mostrarNotificacao(`Lembrete: Você já guardou os ${formatCurrency(planoQuitacaoAtivo.poupancaDiaria)} de hoje para sua meta?`);
                    }, 2000);
                }
                
                const initialPage = window.location.hash.substring(1) || 'dashboard';
                showPage(initialPage, false);
            }
            init();
        });
    </script>
</body>
</html>
